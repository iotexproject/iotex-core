// Copyright (c) 2019 IoTeX Foundation
// This is an alpha (internal) release and is not suitable for production. This source code is provided 'as is' and no
// warranties are given as to title or non-infringement, merchantability or fitness for purpose and, to the extent
// permitted by law, all liability for your use of the code is disclaimed. This source code is governed by Apache
// License 2.0 that can be found in the LICENSE file.

package integrity

import (
	"context"
	"encoding/hex"
	"fmt"
	"math/big"
	"sync"
	"testing"
	"time"

	"github.com/ethereum/go-ethereum/crypto"
	"github.com/golang/mock/gomock"
	"github.com/pkg/errors"
	"github.com/stretchr/testify/require"

	"github.com/iotexproject/go-pkgs/hash"
	"github.com/iotexproject/iotex-address/address"
	"github.com/iotexproject/iotex-proto/golang/iotextypes"

	"github.com/iotexproject/iotex-core/action"
	"github.com/iotexproject/iotex-core/action/protocol"
	"github.com/iotexproject/iotex-core/action/protocol/account"
	accountutil "github.com/iotexproject/iotex-core/action/protocol/account/util"
	"github.com/iotexproject/iotex-core/action/protocol/execution"
	"github.com/iotexproject/iotex-core/action/protocol/execution/evm"
	"github.com/iotexproject/iotex-core/action/protocol/poll"
	"github.com/iotexproject/iotex-core/action/protocol/rewarding"
	"github.com/iotexproject/iotex-core/action/protocol/rolldpos"
	"github.com/iotexproject/iotex-core/action/protocol/vote/candidatesutil"
	"github.com/iotexproject/iotex-core/actpool"
	"github.com/iotexproject/iotex-core/blockchain"
	"github.com/iotexproject/iotex-core/blockchain/block"
	"github.com/iotexproject/iotex-core/blockchain/blockdao"
	"github.com/iotexproject/iotex-core/blockchain/genesis"
	"github.com/iotexproject/iotex-core/blockindex"
	"github.com/iotexproject/iotex-core/config"
	"github.com/iotexproject/iotex-core/db"
	"github.com/iotexproject/iotex-core/db/trie"
	"github.com/iotexproject/iotex-core/db/trie/mptrie"
	"github.com/iotexproject/iotex-core/pkg/unit"
	"github.com/iotexproject/iotex-core/state"
	"github.com/iotexproject/iotex-core/state/factory"
	"github.com/iotexproject/iotex-core/test/identityset"
	"github.com/iotexproject/iotex-core/test/mock/mock_blockcreationsubscriber"
	"github.com/iotexproject/iotex-core/testutil"
)

var (
	deployHash      hash.Hash256                                                                           // in block 1
	setHash         hash.Hash256                                                                           // in block 2
	shrHash         hash.Hash256                                                                           // in block 3
	shlHash         hash.Hash256                                                                           // in block 4
	sarHash         hash.Hash256                                                                           // in block 5
	extHash         hash.Hash256                                                                           // in block 6
	crt2Hash        hash.Hash256                                                                           // in block 7
	storeHash       hash.Hash256                                                                           // in block 8
	store2Hash      hash.Hash256                                                                           // in block 9
	setTopic, _     = hex.DecodeString("fe00000000000000000000000000000000000000000000000000000000001f40") // in block 2
	getTopic, _     = hex.DecodeString("0000000000000000000000000000000000000000000000000000000000000001") // in block 2
	shrTopic, _     = hex.DecodeString("00fe00000000000000000000000000000000000000000000000000000000001f") // in block 3
	shlTopic, _     = hex.DecodeString("fe00000000000000000000000000000000000000000000000000000000001f00") // in block 4
	sarTopic, _     = hex.DecodeString("fffe00000000000000000000000000000000000000000000000000000000001f") // in block 5
	extTopic, _     = hex.DecodeString("4a98ce81a2fd5177f0f42b49cb25b01b720f9ce8019f3937f63b789766c938e2") // in block 6
	crt2Topic, _    = hex.DecodeString("0000000000000000000000001895e6033cd1081f18e0bd23a4501d9376028523") // in block 7
	preGrPreStore   *big.Int
	preGrPostStore  *big.Int
	postGrPostStore *big.Int
)

func addTestingConstantinopleBlocks(bc blockchain.Blockchain, dao blockdao.BlockDAO, sf factory.Factory, ap actpool.ActPool) error {
	// Add block 1
	priKey0 := identityset.PrivateKey(27)
	data, err := hex.DecodeString("608060405234801561001057600080fd5b506104d5806100206000396000f3fe608060405234801561001057600080fd5b50600436106100885760003560e01c806381ea44081161005b57806381ea440814610101578063a91b336214610159578063c2bc2efc14610177578063f5eacece146101cf57610088565b80635bec9e671461008d57806360fe47b1146100975780636bc8ecaa146100c5578063744f5f83146100e3575b600080fd5b6100956101ed565b005b6100c3600480360360208110156100ad57600080fd5b8101908080359060200190929190505050610239565b005b6100cd610270565b6040518082815260200191505060405180910390f35b6100eb6102b3565b6040518082815260200191505060405180910390f35b6101436004803603602081101561011757600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff1690602001909291905050506102f6565b6040518082815260200191505060405180910390f35b61016161036a565b6040518082815260200191505060405180910390f35b6101b96004803603602081101561018d57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff1690602001909291905050506103ad565b6040518082815260200191505060405180910390f35b6101d761045f565b6040518082815260200191505060405180910390f35b5b60011561020b5760008081548092919060010191905055506101ee565b7f8bfaa460932ccf8751604dd60efa3eafa220ec358fccb32ef703f91c509bc3ea60405160405180910390a1565b80600081905550807fdf7a95aebff315db1b7716215d602ab537373cdb769232aae6055c06e798425b60405160405180910390a250565b6000805460081d905080600081905550807fdf7a95aebff315db1b7716215d602ab537373cdb769232aae6055c06e798425b60405160405180910390a280905090565b6000805460081c905080600081905550807fdf7a95aebff315db1b7716215d602ab537373cdb769232aae6055c06e798425b60405160405180910390a280905090565b60008073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16141561033157600080fd5b813f9050807fdf7a95aebff315db1b7716215d602ab537373cdb769232aae6055c06e798425b60405160405180910390a2809050919050565b6000805460081b905080600081905550807fdf7a95aebff315db1b7716215d602ab537373cdb769232aae6055c06e798425b60405160405180910390a280905090565b60008073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1614156103e857600080fd5b7fbde7a70c2261170a87678200113c8e12f82f63d0a1d1cfa45681cbac328e87e382600054604051808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018281526020019250505060405180910390a16000549050919050565b60008080602060406000f59150817fdf7a95aebff315db1b7716215d602ab537373cdb769232aae6055c06e798425b60405160405180910390a2819150509056fea265627a7a72305820209a8ef04c4d621759f34878b27b238650e8605c8a71d6efc619a769a64aa9cc64736f6c634300050a0032")
	if err != nil {
		return err
	}
	ex1, err := testutil.SignedExecution(action.EmptyAddress, priKey0, 1, big.NewInt(0), 500000, big.NewInt(testutil.TestGasPriceInt64), data)
	if err != nil {
		return err
	}
	deployHash = ex1.Hash()
	if err := ap.Add(context.Background(), ex1); err != nil {
		return err
	}
	blockTime := time.Unix(1546329600, 0)
	blk, err := bc.MintNewBlock(blockTime)
	if err != nil {
		return err
	}
	if err := bc.CommitBlock(blk); err != nil {
		return err
	}

	// get deployed contract address
	var contract string
	if dao != nil {
		r, err := dao.GetReceiptByActionHash(deployHash, 1)
		if err != nil {
			return err
		}
		contract = r.ContractAddress
	}

	addOneBlock := func(contract string, nonce uint64, amount *big.Int, gasLimit uint64, gasPrice *big.Int, data []byte) (hash.Hash256, error) {
		ex1, err := testutil.SignedExecution(contract, priKey0, nonce, amount, gasLimit, gasPrice, data)
		if err != nil {
			return hash.ZeroHash256, err
		}
		blockTime = blockTime.Add(time.Second)
		if err := ap.Add(context.Background(), ex1); err != nil {
			return hash.ZeroHash256, err
		}
		blk, err = bc.MintNewBlock(blockTime)
		if err != nil {
			return hash.ZeroHash256, err
		}
		if err := bc.CommitBlock(blk); err != nil {
			return hash.ZeroHash256, err
		}
		return ex1.Hash(), nil
	}

	var (
		zero     = big.NewInt(0)
		gasLimit = testutil.TestGasLimit * 5
		gasPrice = big.NewInt(testutil.TestGasPriceInt64)
	)

	// Add block 2
	// call set() to set storedData = 0xfe...1f40
	funcSig := hash.Hash256b([]byte("set(uint256)"))
	data = append(funcSig[:4], setTopic...)
	setHash, err = addOneBlock(contract, 2, zero, gasLimit, gasPrice, data)
	if err != nil {
		return err
	}

	// Add block 3
	// call shright() to test SHR opcode, storedData => 0x00fe...1f
	funcSig = hash.Hash256b([]byte("shright()"))
	shrHash, err = addOneBlock(contract, 3, zero, gasLimit, gasPrice, funcSig[:4])
	if err != nil {
		return err
	}

	// Add block 4
	// call shleft() to test SHL opcode, storedData => 0xfe...1f00
	funcSig = hash.Hash256b([]byte("shleft()"))
	shlHash, err = addOneBlock(contract, 4, zero, gasLimit, gasPrice, funcSig[:4])
	if err != nil {
		return err
	}

	// Add block 5
	// call saright() to test SAR opcode, storedData => 0xfffe...1f
	funcSig = hash.Hash256b([]byte("saright()"))
	sarHash, err = addOneBlock(contract, 5, zero, gasLimit, gasPrice, funcSig[:4])
	if err != nil {
		return err
	}

	// Add block 6
	// call getCodeHash() to test EXTCODEHASH opcode
	funcSig = hash.Hash256b([]byte("getCodeHash(address)"))
	addr, _ := address.FromString(contract)
	ethaddr := hash.BytesToHash256(addr.Bytes())
	data = append(funcSig[:4], ethaddr[:]...)
	extHash, err = addOneBlock(contract, 6, zero, gasLimit, gasPrice, data)
	if err != nil {
		return err
	}

	// Add block 7
	// call create2() to test CREATE2 opcode
	funcSig = hash.Hash256b([]byte("create2()"))
	crt2Hash, err = addOneBlock(contract, 7, zero, gasLimit, gasPrice, funcSig[:4])
	if err != nil {
		return err
	}

	// Add block 8
	// test store out of gas
	var (
		caller     state.Account
		callerAddr = hash.BytesToHash160(identityset.Address(27).Bytes())
	)
	_, err = sf.State(&caller, protocol.LegacyKeyOption(callerAddr))
	if err != nil {
		return err
	}
	preGrPreStore = new(big.Int).Set(caller.Balance)
	data, _ = hex.DecodeString("60806040526040516200332738038062003327833981810160405260808110156200002957600080fd5b8101908080519060200190929190805190602001909291908051906020019092919080519060200190929190505050838383836200006c620004c860201b60201c565b8411620000c5576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401808060200182810382526026815260200180620033016026913960400191505060405180910390fd5b6000620000d885620004d960201b60201c565b9050620000eb81620004f860201b60201c565b62000142576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602d8152602001806200328b602d913960400191505060405180910390fd5b803410156200019d576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401808060200182810382526022815260200180620032b86022913960400191505060405180910390fd5b42620001ae620007e960201b60201c565b84031162000208576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401808060200182810382526027815260200180620032da6027913960400191505060405180910390fd5b806003819055508260058190555081600260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555083600681905550336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506000349050600354810390506000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167f327ca9276da9073b583440165cb887319e7aeaf4003f14e92c1bbeee913e9b9c6003546040518082815260200191505060405180910390a26000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc829081150290604051600060405180830381858888f1935050505015801562000383573d6000803e3d6000fd5b506000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167fb54ecacfeaef46d29d83a7ee9ffaae207283e8a0f5df648dba2d52a1454e489e826040518082815260200191505060405180910390a26000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167f53ddc5f55aac282e58e964d06a34c46ab814f1ea04d4ccf6eed6df8ba36d3f5e600354600654604051808381526020018281526020019250505060405180910390a26000600760016101000a81548160ff0219169083600e8111156200048e57fe5b02179055506000600760006101000a81548160ff02191690836004811115620004b357fe5b02179055505050505050505050505062000a56565b6000683635c9adc5dea00000905090565b6000680ad78ebc5ac6200000808381620004ef57fe5b04029050919050565b6000806000905062000512836000620007f460201b60201c565b81101562000530576200052d836000620007f460201b60201c565b90505b62000543836001620007f460201b60201c565b81101562000561576200055e836001620007f460201b60201c565b90505b62000574836002620007f460201b60201c565b81101562000592576200058f836002620007f460201b60201c565b90505b620005a5836003620007f460201b60201c565b811015620005c357620005c0836003620007f460201b60201c565b90505b620005d6836004620007f460201b60201c565b811015620005f457620005f1836004620007f460201b60201c565b90505b62000607836005620007f460201b60201c565b811015620006255762000622836005620007f460201b60201c565b90505b62000638836006620007f460201b60201c565b811015620006565762000653836006620007f460201b60201c565b90505b62000669836007620007f460201b60201c565b811015620006875762000684836007620007f460201b60201c565b90505b6200069a836008620007f460201b60201c565b811015620006b857620006b5836008620007f460201b60201c565b90505b620006cb836009620007f460201b60201c565b811015620006e957620006e6836009620007f460201b60201c565b90505b620006fc83600a620007f460201b60201c565b8110156200071a576200071783600a620007f460201b60201c565b90505b6200072d83600b620007f460201b60201c565b8110156200074b576200074883600b620007f460201b60201c565b90505b6200075e83600c620007f460201b60201c565b8110156200077c576200077983600c620007f460201b60201c565b90505b6200078f83600d620007f460201b60201c565b811015620007ad57620007aa83600d620007f460201b60201c565b90505b620007c083600e620007f460201b60201c565b811015620007de57620007db83600e620007f460201b60201c565b90505b828114915050919050565b600062015180905090565b60006008600e8111156200080457fe5b82600e8111156200081157fe5b14806200083657506009600e8111156200082757fe5b82600e8111156200083457fe5b145b806200085a5750600a600e8111156200084b57fe5b82600e8111156200085857fe5b145b806200087e5750600b600e8111156200086f57fe5b82600e8111156200087c57fe5b145b80620008a25750600c600e8111156200089357fe5b82600e811115620008a057fe5b145b80620008c65750600d600e811115620008b757fe5b82600e811115620008c457fe5b145b80620008e95750600e80811115620008da57fe5b82600e811115620008e757fe5b145b15620009035760018381620008fa57fe5b04905062000a50565b6004600e8111156200091157fe5b82600e8111156200091e57fe5b14156200093957600883816200093057fe5b04905062000a50565b6005600e8111156200094757fe5b82600e8111156200095457fe5b14156200096f57600683816200096657fe5b04905062000a50565b6006600e8111156200097d57fe5b82600e8111156200098a57fe5b1415620009a557600383816200099c57fe5b04905062000a50565b6007600e811115620009b357fe5b82600e811115620009c057fe5b1415620009db5760028381620009d257fe5b04905062000a50565b6002600e811115620009e957fe5b82600e811115620009f657fe5b141562000a11576001838162000a0857fe5b04905062000a50565b6000600e81111562000a1f57fe5b82600e81111562000a2c57fe5b141562000a4b5762000a43620004c860201b60201c565b905062000a50565b600090505b92915050565b6128258062000a666000396000f3fe6080604052600436106101355760003560e01c8063996b6fc1116100ab578063b7213b521161006f578063b7213b5214610460578063c6ee20d2146104af578063c9744029146104e8578063cea1295914610513578063d7606c4114610541578063fa6642c61461059d57610135565b8063996b6fc11461034a578063a307afda14610375578063a81af5f7146103a0578063a89ae4ba146103cb578063ab7695121461042257610135565b80632b68bb2d116100fd5780632b68bb2d1461021c5780633e9ee9e5146102265780635e4ff9b7146102515780636f09caed1461028f5780637150d8ae146102c857806392e4a9ea1461031f57610135565b806308551a531461013a5780630a9020271461019157806311da60b4146101bc578063142dfaa6146101c65780631856c845146101f1575b600080fd5b34801561014657600080fd5b5061014f6105f0565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34801561019d57600080fd5b506101a6610615565b6040518082815260200191505060405180910390f35b6101c461061b565b005b3480156101d257600080fd5b506101db610b52565b6040518082815260200191505060405180910390f35b3480156101fd57600080fd5b50610206610b5d565b6040518082815260200191505060405180910390f35b610224610b63565b005b34801561023257600080fd5b5061023b610d48565b6040518082815260200191505060405180910390f35b34801561025d57600080fd5b5061028d6004803603602081101561027457600080fd5b81019080803560ff169060200190929190505050610d53565b005b34801561029b57600080fd5b506102a4610f88565b6040518082600e8111156102b457fe5b60ff16815260200191505060405180910390f35b3480156102d457600080fd5b506102dd610f9b565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34801561032b57600080fd5b50610334610fc1565b6040518082815260200191505060405180910390f35b34801561035657600080fd5b5061035f610fcc565b6040518082815260200191505060405180910390f35b34801561038157600080fd5b5061038a610fd7565b6040518082815260200191505060405180910390f35b3480156103ac57600080fd5b506103b5610fdd565b6040518082815260200191505060405180910390f35b3480156103d757600080fd5b506103e0610fe3565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34801561042e57600080fd5b5061045e6004803603602081101561044557600080fd5b81019080803560ff169060200190929190505050611009565b005b34801561046c57600080fd5b506104996004803603602081101561048357600080fd5b810190808035906020019092919050505061121a565b6040518082815260200191505060405180910390f35b3480156104bb57600080fd5b506104c4611238565b604051808260048111156104d457fe5b60ff16815260200191505060405180910390f35b3480156104f457600080fd5b506104fd61124b565b6040518082815260200191505060405180910390f35b61053f6004803603602081101561052957600080fd5b810190808035906020019092919050505061125c565b005b34801561054d57600080fd5b506105876004803603604081101561056457600080fd5b8101908080359060200190929190803560ff1690602001909291905050506116c6565b6040518082815260200191505060405180910390f35b3480156105a957600080fd5b506105d6600480360360208110156105c057600080fd5b81019080803590602001909291905050506118ec565b604051808215151515815260200191505060405180910390f35b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60035481565b42610624610fcc565b600554011061067e576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260438152602001806127ae6043913960600191505060405180910390fd5b6002600481111561068b57fe5b600760009054906101000a900460ff1660048111156106a657fe5b14806106d75750600160048111156106ba57fe5b600760009054906101000a900460ff1660048111156106d557fe5b145b61072c576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602e815260200180612716602e913960400191505060405180910390fd5b6000600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905060008173ffffffffffffffffffffffffffffffffffffffff16638da5cb5b6040518163ffffffff1660e01b815260040160206040518083038186803b15801561079b57600080fd5b505afa1580156107af573d6000803e3d6000fd5b505050506040513d60208110156107c557600080fd5b8101908080519060200190929190505050905060003073ffffffffffffffffffffffffffffffffffffffff163190506000610811600354600760019054906101000a900460ff166116c6565b9050808203915060008114610999576000600e81111561082d57fe5b600760019054906101000a900460ff16600e81111561084857fe5b1461092b5760008473ffffffffffffffffffffffffffffffffffffffff166329e2caad836040518263ffffffff1660e01b81526004018082815260200191505060206040518083038186803b1580156108a057600080fd5b505afa1580156108b4573d6000803e3d6000fd5b505050506040513d60208110156108ca57600080fd5b8101908080519060200190929190505050905080820391508373ffffffffffffffffffffffffffffffffffffffff166108fc829081150290604051600060405180830381858888f19350505050158015610928573d6000803e3d6000fd5b50505b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc829081150290604051600060405180830381858888f19350505050158015610993573d6000803e3d6000fd5b50610aac565b6000600e8111156109a657fe5b600760019054906101000a900460ff16600e8111156109c157fe5b14610aab5760008473ffffffffffffffffffffffffffffffffffffffff166329e2caad6109ec61124b565b6040518263ffffffff1660e01b81526004018082815260200191505060206040518083038186803b158015610a2057600080fd5b505afa158015610a34573d6000803e3d6000fd5b505050506040513d6020811015610a4a57600080fd5b8101908080519060200190929190505050905080830392508373ffffffffffffffffffffffffffffffffffffffff166108fc829081150290604051600060405180830381858888f19350505050158015610aa8573d6000803e3d6000fd5b50505b5b6000829050818303925060008114610b27576000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc829081150290604051600060405180830381858888f19350505050158015610b25573d6000803e3d6000fd5b505b6003600760006101000a81548160ff02191690836004811115610b4657fe5b02179055505050505050565b600062015180905090565b60045481565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610c08576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260238152602001806126bb6023913960400191505060405180910390fd5b60006004811115610c1557fe5b600760009054906101000a900460ff166004811115610c3057fe5b14610ca3576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601f8152602001807f636f6e747261637420737461747573206e65656420746f206265206f70656e0081525060200191505060405180910390fd5b6004600760006101000a81548160ff02191690836004811115610cc257fe5b02179055506000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc3073ffffffffffffffffffffffffffffffffffffffff16319081150290604051600060405180830381858888f19350505050158015610d45573d6000803e3d6000fd5b50565b600062015180905090565b600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610df9576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260288152602001806127866028913960400191505060405180910390fd5b42610e02610b52565b6005540110610e5c576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260448152602001806126076044913960600191505060405180910390fd5b42610e65610fc1565b600554011015610ec0576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252604381526020018061264b6043913960600191505060405180910390fd5b60016004811115610ecd57fe5b600760009054906101000a900460ff166004811115610ee857fe5b14610f3e576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602d81526020018061268e602d913960400191505060405180910390fd5b80600760016101000a81548160ff0219169083600e811115610f5c57fe5b02179055506002600760006101000a81548160ff02191690836004811115610f8057fe5b021790555050565b600760019054906101000a900460ff1681565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60006203f480905090565b600062054600905090565b60055481565b60065481565b600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146110af576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602881526020018061259b6028913960400191505060405180910390fd5b426110b8610fc1565b6005540110611112576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260428152602001806127446042913960600191505060405180910390fd5b4261111b610fcc565b600554011015611176576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260448152602001806125c36044913960600191505060405180910390fd5b6002600481111561118357fe5b600760009054906101000a900460ff16600481111561119e57fe5b146111f4576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602e815260200180612716602e913960400191505060405180910390fd5b80600760016101000a81548160ff0219169083600e81111561121257fe5b021790555050565b6000680ad78ebc5ac620000080838161122f57fe5b04029050919050565b600760009054906101000a900460ff1681565b6000683635c9adc5dea00000905090565b61126461124b565b3410156112d9576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601e8152602001807f696e73756666696369656e742066756e6420666f72207072656d69756d21000081525060200191505060405180910390fd5b426112e2610d48565b600554031161133c576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260388152602001806126de6038913960400191505060405180910390fd5b6000600481111561134957fe5b600760009054906101000a900460ff16600481111561136457fe5b146113d7576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601f8152602001807f636f6e747261637420737461747573206e65656420746f206265206f70656e0081525060200191505060405180910390fd5b600115156113e4826118ec565b151514611459576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601a8152602001807f646f206e6f7420737570706f7274207468697320666c6967687400000000000081525060200191505060405180910390fd5b33600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060003490506114a761124b565b81039050600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167f17c2f3e0d2d7ead2d68931154e83b5320959605ec7397093a1bd845a60e29c4761150d61124b565b6040518082815260200191505060405180910390a2600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc829081150290604051600060405180830381858888f1935050505015801561158a573d6000803e3d6000fd5b5081600481905550600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167fd6457c06d7a832c2724560b589156fc0a34d1eea0aae901b1e12d5e279a8f99a826040518082815260200191505060405180910390a2600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167f596bcc7183bdee7c7371c9072d6e4c6b30dea4f278756da86ed4ec7e471c484030604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390a26001600760006101000a81548160ff021916908360048111156116bd57fe5b02179055505050565b60006008600e8111156116d557fe5b82600e8111156116e157fe5b148061170357506009600e8111156116f557fe5b82600e81111561170157fe5b145b806117245750600a600e81111561171657fe5b82600e81111561172257fe5b145b806117455750600b600e81111561173757fe5b82600e81111561174357fe5b145b806117665750600c600e81111561175857fe5b82600e81111561176457fe5b145b806117875750600d600e81111561177957fe5b82600e81111561178557fe5b145b806117a75750600e8081111561179957fe5b82600e8111156117a557fe5b145b156117be57600183816117b657fe5b0490506118e6565b6004600e8111156117cb57fe5b82600e8111156117d757fe5b14156117ef57600883816117e757fe5b0490506118e6565b6005600e8111156117fc57fe5b82600e81111561180857fe5b1415611820576006838161181857fe5b0490506118e6565b6006600e81111561182d57fe5b82600e81111561183957fe5b1415611851576003838161184957fe5b0490506118e6565b6007600e81111561185e57fe5b82600e81111561186a57fe5b1415611882576002838161187a57fe5b0490506118e6565b6002600e81111561188f57fe5b82600e81111561189b57fe5b14156118b357600183816118ab57fe5b0490506118e6565b6000600e8111156118c057fe5b82600e8111156118cc57fe5b14156118e1576118da61124b565b90506118e6565b600090505b92915050565b60007f415320323636000000000000000000000000000000000000000000000000000082148061193b57507f415320333236000000000000000000000000000000000000000000000000000082145b8061196557507f415320333430000000000000000000000000000000000000000000000000000082145b8061198f57507f415320333633000000000000000000000000000000000000000000000000000082145b806119b957507f415320333735000000000000000000000000000000000000000000000000000082145b806119e357507f415320373833000000000000000000000000000000000000000000000000000082145b80611a0d57507f415320363237000000000000000000000000000000000000000000000000000082145b80611a3757507f415320363239000000000000000000000000000000000000000000000000000082145b80611a6157507f415320363537000000000000000000000000000000000000000000000000000082145b80611a8b57507f415320363635000000000000000000000000000000000000000000000000000082145b80611ab557507f415320373836000000000000000000000000000000000000000000000000000082145b80611adf57507f415320313032320000000000000000000000000000000000000000000000000082145b80611b0957507f415320313032340000000000000000000000000000000000000000000000000082145b15611b175760019050612595565b7f5541203231330000000000000000000000000000000000000000000000000000821480611b6457507f554120323935000000000000000000000000000000000000000000000000000082145b80611b8e57507f554120343937000000000000000000000000000000000000000000000000000082145b80611bb857507f554120353335000000000000000000000000000000000000000000000000000082145b80611be257507f554120353737000000000000000000000000000000000000000000000000000082145b80611c0c57507f554120353833000000000000000000000000000000000000000000000000000082145b80611c3657507f554120373533000000000000000000000000000000000000000000000000000082145b80611c6057507f554120383430000000000000000000000000000000000000000000000000000082145b80611c8a57507f554120313235370000000000000000000000000000000000000000000000000082145b80611cb457507f554120313438330000000000000000000000000000000000000000000000000082145b80611cde57507f554120313532360000000000000000000000000000000000000000000000000082145b80611d0857507f554120313538340000000000000000000000000000000000000000000000000082145b80611d3257507f554120313739360000000000000000000000000000000000000000000000000082145b80611d5c57507f554120313834380000000000000000000000000000000000000000000000000082145b80611d8657507f554120313937380000000000000000000000000000000000000000000000000082145b80611db057507f554120323030360000000000000000000000000000000000000000000000000082145b80611dda57507f554120323034340000000000000000000000000000000000000000000000000082145b80611e0457507f554120323036350000000000000000000000000000000000000000000000000082145b80611e2e57507f554120323038300000000000000000000000000000000000000000000000000082145b80611e5857507f554120323136300000000000000000000000000000000000000000000000000082145b80611e8257507f554120323233390000000000000000000000000000000000000000000000000082145b80611eac57507f554120323331390000000000000000000000000000000000000000000000000082145b15611eba5760019050612595565b7f4141203136000000000000000000000000000000000000000000000000000000821480611f0757507f414120373600000000000000000000000000000000000000000000000000000082145b80611f3157507f414120313634000000000000000000000000000000000000000000000000000082145b80611f5b57507f414120313636000000000000000000000000000000000000000000000000000082145b80611f8557507f414120313737000000000000000000000000000000000000000000000000000082145b80611faf57507f414120313739000000000000000000000000000000000000000000000000000082145b80611fd957507f414120323334000000000000000000000000000000000000000000000000000082145b8061200357507f414120323736000000000000000000000000000000000000000000000000000082145b8061202d57507f414120323330350000000000000000000000000000000000000000000000000082145b8061205757507f414120323635320000000000000000000000000000000000000000000000000082145b156120655760019050612595565b7f42362031350000000000000000000000000000000000000000000000000000008214806120b257507f423620313600000000000000000000000000000000000000000000000000000082145b806120dc57507f423620313637000000000000000000000000000000000000000000000000000082145b8061210657507f423620313638000000000000000000000000000000000000000000000000000082145b8061213057507f423620343135000000000000000000000000000000000000000000000000000082145b8061215a57507f423620343136000000000000000000000000000000000000000000000000000082145b8061218457507f423620353136000000000000000000000000000000000000000000000000000082145b806121ae57507f423620363135000000000000000000000000000000000000000000000000000082145b806121d857507f423620363136000000000000000000000000000000000000000000000000000082145b8061220257507f423620363639000000000000000000000000000000000000000000000000000082145b8061222c57507f423620363730000000000000000000000000000000000000000000000000000082145b8061225657507f423620393135000000000000000000000000000000000000000000000000000082145b8061228057507f423620393136000000000000000000000000000000000000000000000000000082145b806122aa57507f423620313431350000000000000000000000000000000000000000000000000082145b806122d457507f423620313531360000000000000000000000000000000000000000000000000082145b806122fe57507f423620313731350000000000000000000000000000000000000000000000000082145b1561230c5760019050612595565b7f444c20343236000000000000000000000000000000000000000000000000000082148061235957507f444c20343330000000000000000000000000000000000000000000000000000082145b8061238357507f444c20343930000000000000000000000000000000000000000000000000000082145b806123ad57507f444c20363130000000000000000000000000000000000000000000000000000082145b806123d757507f444c20363433000000000000000000000000000000000000000000000000000082145b8061240157507f444c20383638000000000000000000000000000000000000000000000000000082145b8061242b57507f444c20393336000000000000000000000000000000000000000000000000000082145b8061245557507f444c20313534380000000000000000000000000000000000000000000000000082145b8061247f57507f444c20313835390000000000000000000000000000000000000000000000000082145b806124a957507f444c20323637300000000000000000000000000000000000000000000000000082145b156124b75760019050612595565b7f484120323335330000000000000000000000000000000000000000000000000082148061250457507f484120323335320000000000000000000000000000000000000000000000000082145b8061252e57507f484120323336300000000000000000000000000000000000000000000000000082145b8061255857507f484120323336310000000000000000000000000000000000000000000000000082145b8061258257507f484120323336320000000000000000000000000000000000000000000000000082145b156125905760019050612595565b600090505b91905056fe6f6e6c7920726567697374726564206f7261636c652063616e206368616e676520726573756c742173686f756c64206368616e6765206265666f726520287363686564756c655f74616b655f6f66665f74696d65202b20656e645f646973707574655f696e74657276616c2973686f756c64207265706f727420616674657220287363686564756c655f74616b655f6f66665f74696d65202b2073746172745f7265706f72745f696e74657276616c2973686f756c64207265706f7274206265666f726520287363686564756c655f74616b655f6f66665f74696d65202b20656e645f7265706f72745f696e74657276616c29636f6e747261637420737461747573206e65656420746f2062652077616974696e6720666f72207265706f72746f6e6c79206f776e65722063616e2063616e63656c207468697320636f6e747261637473686f756c64206275792067657446726f7a656e506572696f64206265666f7265207363686564756c652074616b65206f66662074696d65636f6e747261637420737461747573206e65656420746f2062652077616974696e6720666f72206469737075746573686f756c64206368616e676520616674657220287363686564756c655f74616b655f6f66665f74696d65202b20656e645f7265706f72745f696e74657276616c296f6e6c7920726567697374726564206f7261636c652063616e207265706f727420726573756c742173686f756c6420736574746c6520616674657220287363686564756c655f74616b655f6f66665f74696d65202b20656e645f646973707574655f696e74657276616c29a265627a7a72315820612ed13838b4a948337cce571ea68c9fc0e970d7cf3fb2271f2606a6dc6b4f4264736f6c634300050b00327265616c206d61782062656e656669742073686f756c6420657175616c20746f206d61782062656e6566697421696e73756666696369656e7420696e697469616c206465706f7369742066756e64217363686564756c652074616b65206f66662074696d652073686f756c64206174206c65617374206d61782062656e656669742073686f756c64206c6172676572207468616e207072656d69756d00000000000000000000000000000000000000000000021e19e0c9bab2400000323031392d31302d313700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005da9004400000000000000000000000079f3574d440c21029eecb8e9ee66b23b26cbcb38")
	storeHash, err = addOneBlock(action.EmptyAddress, 8, unit.ConvertIotxToRau(10000), 3000000, big.NewInt(unit.Qev), data)
	if err != nil {
		return err
	}

	if dao != nil {
		r, err := dao.GetReceiptByActionHash(storeHash, 8)
		if err != nil {
			return err
		}
		if r.Status != uint64(iotextypes.ReceiptStatus_ErrCodeStoreOutOfGas) {
			return blockchain.ErrBalance
		}
	}

	// Add block 9
	// test store out of gas
	_, err = sf.State(&caller, protocol.LegacyKeyOption(callerAddr))
	if err != nil {
		return err
	}
	preGrPostStore = new(big.Int).Set(caller.Balance)
	store2Hash, err = addOneBlock(action.EmptyAddress, 9, unit.ConvertIotxToRau(10000), 3000000, big.NewInt(unit.Qev), data)
	if err != nil {
		return err
	}

	if dao != nil {
		r, err := dao.GetReceiptByActionHash(store2Hash, 9)
		if err != nil {
			return err
		}
		if r.Status != uint64(iotextypes.ReceiptStatus_ErrCodeStoreOutOfGas) {
			return blockchain.ErrBalance
		}
	}

	_, err = sf.State(&caller, protocol.LegacyKeyOption(callerAddr))
	if err != nil {
		return err
	}
	postGrPostStore = new(big.Int).Set(caller.Balance)
	return nil
}

func addTestingTsfBlocks(cfg config.Config, bc blockchain.Blockchain, dao blockdao.BlockDAO, ap actpool.ActPool) error {
	// Add block 1
	addr0 := identityset.Address(27).String()
	tsf0, err := testutil.SignedTransfer(addr0, identityset.PrivateKey(0), 1, big.NewInt(90000000), nil, testutil.TestGasLimit, big.NewInt(testutil.TestGasPriceInt64))
	if err != nil {
		return err
	}
	if err := ap.Add(context.Background(), tsf0); err != nil {
		return err
	}
	blk, err := bc.MintNewBlock(testutil.TimestampNow())
	if err != nil {
		return err
	}
	if err := bc.CommitBlock(blk); err != nil {
		return err
	}
	ap.Reset()

	priKey0 := identityset.PrivateKey(27)
	addr1 := identityset.Address(28).String()
	priKey1 := identityset.PrivateKey(28)
	addr2 := identityset.Address(29).String()
	priKey2 := identityset.PrivateKey(29)
	addr3 := identityset.Address(30).String()
	priKey3 := identityset.PrivateKey(30)
	addr4 := identityset.Address(31).String()
	priKey4 := identityset.PrivateKey(31)
	addr5 := identityset.Address(32).String()
	priKey5 := identityset.PrivateKey(32)
	addr6 := identityset.Address(33).String()
	// Add block 2
	// test --> A, B, C, D, E, F
	tsf1, err := testutil.SignedTransfer(addr1, priKey0, 1, big.NewInt(20), []byte{}, testutil.TestGasLimit, big.NewInt(testutil.TestGasPriceInt64))
	if err != nil {
		return err
	}
	if err := ap.Add(context.Background(), tsf1); err != nil {
		return err
	}
	tsf2, err := testutil.SignedTransfer(addr2, priKey0, 2, big.NewInt(30), []byte{}, testutil.TestGasLimit, big.NewInt(testutil.TestGasPriceInt64))
	if err != nil {
		return err
	}
	if err := ap.Add(context.Background(), tsf2); err != nil {
		return err
	}
	tsf3, err := testutil.SignedTransfer(addr3, priKey0, 3, big.NewInt(50), []byte{}, testutil.TestGasLimit, big.NewInt(testutil.TestGasPriceInt64))
	if err != nil {
		return err
	}
	if err := ap.Add(context.Background(), tsf3); err != nil {
		return err
	}
	tsf4, err := testutil.SignedTransfer(addr4, priKey0, 4, big.NewInt(70), []byte{}, testutil.TestGasLimit, big.NewInt(testutil.TestGasPriceInt64))
	if err != nil {
		return err
	}
	if err := ap.Add(context.Background(), tsf4); err != nil {
		return err
	}
	tsf5, err := testutil.SignedTransfer(addr5, priKey0, 5, big.NewInt(110), []byte{}, testutil.TestGasLimit, big.NewInt(testutil.TestGasPriceInt64))
	if err != nil {
		return err
	}
	if err := ap.Add(context.Background(), tsf5); err != nil {
		return err
	}
	tsf6, err := testutil.SignedTransfer(addr6, priKey0, 6, big.NewInt(50<<20), []byte{}, testutil.TestGasLimit, big.NewInt(testutil.TestGasPriceInt64))
	if err != nil {
		return err
	}
	if err := ap.Add(context.Background(), tsf6); err != nil {
		return err
	}
	// deploy simple smart contract
	data, _ := hex.DecodeString("608060405234801561001057600080fd5b50610233806100206000396000f300608060405260043610610057576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680635bec9e671461005c57806360fe47b114610073578063c2bc2efc146100a0575b600080fd5b34801561006857600080fd5b506100716100f7565b005b34801561007f57600080fd5b5061009e60048036038101908080359060200190929190505050610143565b005b3480156100ac57600080fd5b506100e1600480360381019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919050505061017a565b6040518082815260200191505060405180910390f35b5b6001156101155760008081548092919060010191905055506100f8565b7f8bfaa460932ccf8751604dd60efa3eafa220ec358fccb32ef703f91c509bc3ea60405160405180910390a1565b80600081905550807fdf7a95aebff315db1b7716215d602ab537373cdb769232aae6055c06e798425b60405160405180910390a250565b60008073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16141515156101b757600080fd5b6000548273ffffffffffffffffffffffffffffffffffffffff167fbde7a70c2261170a87678200113c8e12f82f63d0a1d1cfa45681cbac328e87e360405160405180910390a360005490509190505600a165627a7a723058203198d0390613dab2dff2fa053c1865e802618d628429b01ab05b8458afc347eb0029")
	ex1, err := testutil.SignedExecution(action.EmptyAddress, priKey2, 1, big.NewInt(0), 200000, big.NewInt(testutil.TestGasPriceInt64), data)
	if err != nil {
		return err
	}
	if err := ap.Add(context.Background(), ex1); err != nil {
		return err
	}
	deployHash = ex1.Hash()
	blk, err = bc.MintNewBlock(testutil.TimestampNow())
	if err != nil {
		return err
	}
	if err := bc.CommitBlock(blk); err != nil {
		return err
	}
	ap.Reset()

	// get deployed contract address
	var contract string
	_, gateway := cfg.Plugins[config.GatewayPlugin]
	if gateway && !cfg.Chain.EnableAsyncIndexWrite {
		r, err := dao.GetReceiptByActionHash(deployHash, 2)
		if err != nil {
			return err
		}
		contract = r.ContractAddress
	}

	// Add block 3
	// Charlie --> A, B, D, E, test
	tsf1, err = testutil.SignedTransfer(addr1, priKey3, 1, big.NewInt(1), []byte{}, testutil.TestGasLimit, big.NewInt(testutil.TestGasPriceInt64))
	if err != nil {
		return err
	}
	if err := ap.Add(context.Background(), tsf1); err != nil {
		return err
	}
	tsf2, err = testutil.SignedTransfer(addr2, priKey3, 2, big.NewInt(1), []byte{}, testutil.TestGasLimit, big.NewInt(testutil.TestGasPriceInt64))
	if err != nil {
		return err
	}
	if err := ap.Add(context.Background(), tsf2); err != nil {
		return err
	}
	tsf3, err = testutil.SignedTransfer(addr4, priKey3, 3, big.NewInt(1), []byte{}, testutil.TestGasLimit, big.NewInt(testutil.TestGasPriceInt64))
	if err != nil {
		return err
	}
	if err := ap.Add(context.Background(), tsf3); err != nil {
		return err
	}
	tsf4, err = testutil.SignedTransfer(addr5, priKey3, 4, big.NewInt(1), []byte{}, testutil.TestGasLimit, big.NewInt(testutil.TestGasPriceInt64))
	if err != nil {
		return err
	}
	if err := ap.Add(context.Background(), tsf4); err != nil {
		return err
	}
	tsf5, err = testutil.SignedTransfer(addr0, priKey3, 5, big.NewInt(1), []byte{}, testutil.TestGasLimit, big.NewInt(testutil.TestGasPriceInt64))
	if err != nil {
		return err
	}
	if err := ap.Add(context.Background(), tsf5); err != nil {
		return err
	}
	// call set() to set storedData = 0x1f40
	data, _ = hex.DecodeString("60fe47b1")
	data = append(data, setTopic...)
	ex1, err = testutil.SignedExecution(contract, priKey2, 2, big.NewInt(0), testutil.TestGasLimit*5, big.NewInt(testutil.TestGasPriceInt64), data)
	if err != nil {
		return err
	}
	if err := ap.Add(context.Background(), ex1); err != nil {
		return err
	}
	blk, err = bc.MintNewBlock(testutil.TimestampNow())
	if err != nil {
		return err
	}
	if err := bc.CommitBlock(blk); err != nil {
		return err
	}
	ap.Reset()

	// Add block 4
	// Delta --> B, E, F, test
	tsf1, err = testutil.SignedTransfer(addr2, priKey4, 1, big.NewInt(1), []byte{}, testutil.TestGasLimit, big.NewInt(testutil.TestGasPriceInt64))
	if err != nil {
		return err
	}
	if err := ap.Add(context.Background(), tsf1); err != nil {
		return err
	}
	tsf2, err = testutil.SignedTransfer(addr5, priKey4, 2, big.NewInt(1), []byte{}, testutil.TestGasLimit, big.NewInt(testutil.TestGasPriceInt64))
	if err != nil {
		return err
	}
	if err := ap.Add(context.Background(), tsf2); err != nil {
		return err
	}
	tsf3, err = testutil.SignedTransfer(addr6, priKey4, 3, big.NewInt(1), []byte{}, testutil.TestGasLimit, big.NewInt(testutil.TestGasPriceInt64))
	if err != nil {
		return err
	}
	if err := ap.Add(context.Background(), tsf3); err != nil {
		return err
	}
	tsf4, err = testutil.SignedTransfer(addr0, priKey4, 4, big.NewInt(1), []byte{}, testutil.TestGasLimit, big.NewInt(testutil.TestGasPriceInt64))
	if err != nil {
		return err
	}
	if err := ap.Add(context.Background(), tsf4); err != nil {
		return err
	}
	data, _ = hex.DecodeString("c2bc2efc")
	data = append(data, getTopic...)
	ex1, err = testutil.SignedExecution(contract, priKey2, 3, big.NewInt(0), testutil.TestGasLimit*5, big.NewInt(testutil.TestGasPriceInt64), data)
	if err != nil {
		return err
	}
	if err := ap.Add(context.Background(), ex1); err != nil {
		return err
	}
	blk, err = bc.MintNewBlock(testutil.TimestampNow())
	if err != nil {
		return err
	}
	if err := bc.CommitBlock(blk); err != nil {
		return err
	}

	// Add block 5
	// Delta --> A, B, C, D, F, test
	tsf1, err = testutil.SignedTransfer(addr1, priKey5, 1, big.NewInt(2), []byte{}, testutil.TestGasLimit, big.NewInt(testutil.TestGasPriceInt64))
	if err != nil {
		return err
	}
	if err := ap.Add(context.Background(), tsf1); err != nil {
		return err
	}
	tsf2, err = testutil.SignedTransfer(addr2, priKey5, 2, big.NewInt(2), []byte{}, testutil.TestGasLimit, big.NewInt(testutil.TestGasPriceInt64))
	if err != nil {
		return err
	}
	if err := ap.Add(context.Background(), tsf2); err != nil {
		return err
	}
	tsf3, err = testutil.SignedTransfer(addr3, priKey5, 3, big.NewInt(2), []byte{}, testutil.TestGasLimit, big.NewInt(testutil.TestGasPriceInt64))
	if err != nil {
		return err
	}
	if err := ap.Add(context.Background(), tsf3); err != nil {
		return err
	}
	tsf4, err = testutil.SignedTransfer(addr4, priKey5, 4, big.NewInt(2), []byte{}, testutil.TestGasLimit, big.NewInt(testutil.TestGasPriceInt64))
	if err != nil {
		return err
	}
	if err := ap.Add(context.Background(), tsf4); err != nil {
		return err
	}
	tsf5, err = testutil.SignedTransfer(addr6, priKey5, 5, big.NewInt(2), []byte{}, testutil.TestGasLimit, big.NewInt(testutil.TestGasPriceInt64))
	if err != nil {
		return err
	}
	if err := ap.Add(context.Background(), tsf5); err != nil {
		return err
	}
	tsf6, err = testutil.SignedTransfer(addr0, priKey5, 6, big.NewInt(2), []byte{}, testutil.TestGasLimit, big.NewInt(testutil.TestGasPriceInt64))
	if err != nil {
		return err
	}
	if err := ap.Add(context.Background(), tsf6); err != nil {
		return err
	}
	tsf7, err := testutil.SignedTransfer(addr3, priKey3, 6, big.NewInt(2), []byte{}, testutil.TestGasLimit, big.NewInt(testutil.TestGasPriceInt64))
	if err != nil {
		return err
	}
	if err := ap.Add(context.Background(), tsf7); err != nil {
		return err
	}
	tsf8, err := testutil.SignedTransfer(addr1, priKey1, 1, big.NewInt(2), []byte{}, testutil.TestGasLimit, big.NewInt(testutil.TestGasPriceInt64))
	if err != nil {
		return err
	}
	if err := ap.Add(context.Background(), tsf8); err != nil {
		return err
	}
	blk, err = bc.MintNewBlock(testutil.TimestampNow())
	if err != nil {
		return err
	}
	return bc.CommitBlock(blk)
}

func TestCreateBlockchain(t *testing.T) {
	require := require.New(t)
	ctx := context.Background()

	cfg := config.Default
	// disable account-based testing
	cfg.Chain.TrieDBPath = ""
	cfg.Genesis.EnableGravityChainVoting = false
	cfg.ActPool.MinGasPriceStr = "0"
	// create chain
	registry := protocol.NewRegistry()
	acc := account.NewProtocol(rewarding.DepositGas)
	require.NoError(acc.Register(registry))
	rp := rolldpos.NewProtocol(cfg.Genesis.NumCandidateDelegates, cfg.Genesis.NumDelegates, cfg.Genesis.NumSubEpochs)
	require.NoError(rp.Register(registry))
	sf, err := factory.NewFactory(cfg, factory.InMemTrieOption(), factory.RegistryOption(registry))
	require.NoError(err)
	ap, err := actpool.NewActPool(sf, cfg.ActPool)
	require.NoError(err)
	dao := blockdao.NewBlockDAO(db.NewMemKVStore(), []blockdao.BlockIndexer{sf}, cfg.Chain.CompressBlock, cfg.DB)
	bc := blockchain.NewBlockchain(
		cfg,
		dao,
		factory.NewMinter(sf, ap),
		blockchain.BlockValidatorOption(block.NewValidator(
			sf,
			protocol.NewGenericValidator(sf, accountutil.AccountState),
		)),
	)
	ep := execution.NewProtocol(dao.GetBlockHash, rewarding.DepositGas)
	require.NoError(ep.Register(registry))
	rewardingProtocol := rewarding.NewProtocol(0, 0)
	require.NoError(rewardingProtocol.Register(registry))
	require.NoError(bc.Start(ctx))
	require.NotNil(bc)
	height := bc.TipHeight()
	require.Equal(0, int(height))
	fmt.Printf("Create blockchain pass, height = %d\n", height)
	defer func() {
		require.NoError(bc.Stop(ctx))
	}()

	// add 4 sample blocks
	require.NoError(addTestingTsfBlocks(cfg, bc, nil, ap))
	height = bc.TipHeight()
	require.Equal(5, int(height))
}

func TestBlockchain_MintNewBlock(t *testing.T) {
	ctx := context.Background()
	cfg := config.Default
	cfg.Genesis.BlockGasLimit = uint64(100000)
	cfg.Genesis.EnableGravityChainVoting = false
	cfg.ActPool.MinGasPriceStr = "0"
	registry := protocol.NewRegistry()
	acc := account.NewProtocol(rewarding.DepositGas)
	require.NoError(t, acc.Register(registry))
	rp := rolldpos.NewProtocol(cfg.Genesis.NumCandidateDelegates, cfg.Genesis.NumDelegates, cfg.Genesis.NumSubEpochs)
	require.NoError(t, rp.Register(registry))
	sf, err := factory.NewFactory(cfg, factory.InMemTrieOption(), factory.RegistryOption(registry))
	require.NoError(t, err)
	ap, err := actpool.NewActPool(sf, cfg.ActPool)
	require.NoError(t, err)
	dao := blockdao.NewBlockDAO(db.NewMemKVStore(), []blockdao.BlockIndexer{sf}, cfg.Chain.CompressBlock, cfg.DB)
	bc := blockchain.NewBlockchain(
		cfg,
		dao,
		factory.NewMinter(sf, ap),
		blockchain.BlockValidatorOption(block.NewValidator(
			sf,
			protocol.NewGenericValidator(sf, accountutil.AccountState),
		)),
	)
	ep := execution.NewProtocol(dao.GetBlockHash, rewarding.DepositGas)
	require.NoError(t, ep.Register(registry))
	rewardingProtocol := rewarding.NewProtocol(0, 0)
	require.NoError(t, rewardingProtocol.Register(registry))
	require.NoError(t, bc.Start(ctx))
	defer func() {
		require.NoError(t, bc.Stop(ctx))
	}()

	tsf, err := action.NewTransfer(
		1,
		big.NewInt(100000000),
		identityset.Address(27).String(),
		[]byte{}, uint64(100000),
		big.NewInt(10),
	)
	require.NoError(t, err)

	data, _ := hex.DecodeString("608060405234801561001057600080fd5b5060df8061001f6000396000f3006080604052600436106049576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806360fe47b114604e5780636d4ce63c146078575b600080fd5b348015605957600080fd5b5060766004803603810190808035906020019092919050505060a0565b005b348015608357600080fd5b50608a60aa565b6040518082815260200191505060405180910390f35b8060008190555050565b600080549050905600a165627a7a7230582002faabbefbbda99b20217cf33cb8ab8100caf1542bf1f48117d72e2c59139aea0029")
	execution, err := action.NewExecution(action.EmptyAddress, 2, big.NewInt(0), uint64(100000), big.NewInt(0), data)
	require.NoError(t, err)

	bd := &action.EnvelopeBuilder{}
	elp1 := bd.SetAction(tsf).
		SetNonce(1).
		SetGasLimit(100000).
		SetGasPrice(big.NewInt(10)).Build()
	selp1, err := action.Sign(elp1, identityset.PrivateKey(0))
	require.NoError(t, err)
	require.NoError(t, ap.Add(context.Background(), selp1))
	// This execution should not be included in block because block is out of gas
	elp2 := bd.SetAction(execution).
		SetNonce(2).
		SetGasLimit(100000).
		SetGasPrice(big.NewInt(10)).Build()
	selp2, err := action.Sign(elp2, identityset.PrivateKey(0))
	require.NoError(t, err)
	require.NoError(t, ap.Add(context.Background(), selp2))

	blk, err := bc.MintNewBlock(testutil.TimestampNow())
	require.NoError(t, err)
	require.Equal(t, 2, len(blk.Actions))
	require.Equal(t, 2, len(blk.Receipts))
	var gasConsumed uint64
	for _, receipt := range blk.Receipts {
		gasConsumed += receipt.GasConsumed
	}
	require.True(t, gasConsumed <= cfg.Genesis.BlockGasLimit)
}

func TestBlockchain_MintNewBlock_PopAccount(t *testing.T) {
	ctx := context.Background()
	cfg := config.Default
	cfg.Genesis.EnableGravityChainVoting = false
	cfg.ActPool.MinGasPriceStr = "0"
	registry := protocol.NewRegistry()
	acc := account.NewProtocol(rewarding.DepositGas)
	require.NoError(t, acc.Register(registry))
	sf, err := factory.NewFactory(cfg, factory.InMemTrieOption(), factory.RegistryOption(registry))
	require.NoError(t, err)
	ap, err := actpool.NewActPool(sf, cfg.ActPool)
	require.NoError(t, err)
	dao := blockdao.NewBlockDAO(db.NewMemKVStore(), []blockdao.BlockIndexer{sf}, cfg.Chain.CompressBlock, cfg.DB)
	bc := blockchain.NewBlockchain(
		cfg,
		dao,
		factory.NewMinter(sf, ap),
		blockchain.BlockValidatorOption(block.NewValidator(
			sf,
			protocol.NewGenericValidator(sf, accountutil.AccountState),
		)),
	)
	rp := rolldpos.NewProtocol(cfg.Genesis.NumCandidateDelegates, cfg.Genesis.NumDelegates, cfg.Genesis.NumSubEpochs)
	require.NoError(t, rp.Register(registry))
	ep := execution.NewProtocol(dao.GetBlockHash, rewarding.DepositGas)
	require.NoError(t, ep.Register(registry))
	rewardingProtocol := rewarding.NewProtocol(0, 0)
	require.NoError(t, rewardingProtocol.Register(registry))
	require.NoError(t, bc.Start(ctx))
	defer func() {
		require.NoError(t, bc.Stop(ctx))
	}()

	priKey0 := identityset.PrivateKey(27)
	addr1 := identityset.Address(28).String()
	priKey3 := identityset.PrivateKey(30)
	require.NoError(t, addTestingTsfBlocks(cfg, bc, nil, ap))

	// test third block
	bytes := []byte{}
	for i := 0; i < 1000; i++ {
		bytes = append(bytes, 1)
	}
	for i := uint64(0); i < 300; i++ {
		tsf, err := testutil.SignedTransfer(addr1, priKey0, i+7, big.NewInt(2), bytes,
			19000, big.NewInt(testutil.TestGasPriceInt64))
		require.NoError(t, err)
		require.NoError(t, ap.Add(context.Background(), tsf))
	}
	transfer1, err := testutil.SignedTransfer(addr1, priKey3, 7, big.NewInt(2),
		[]byte{}, 10000, big.NewInt(testutil.TestGasPriceInt64))
	require.NoError(t, err)
	require.NoError(t, ap.Add(context.Background(), transfer1))

	blk, err := bc.MintNewBlock(testutil.TimestampNow())
	require.NoError(t, err)
	require.NotNil(t, blk)
	require.Equal(t, 183, len(blk.Actions))
	whetherInclude := false
	for _, action := range blk.Actions {
		if transfer1.Hash() == action.Hash() {
			whetherInclude = true
			break
		}
	}
	require.True(t, whetherInclude)
}

type MockSubscriber struct {
	counter int
	mu      sync.RWMutex
}

func (ms *MockSubscriber) ReceiveBlock(blk *block.Block) error {
	ms.mu.Lock()
	tsfs, _ := action.ClassifyActions(blk.Actions)
	ms.counter += len(tsfs)
	ms.mu.Unlock()
	return nil
}

func (ms *MockSubscriber) Counter() int {
	ms.mu.RLock()
	defer ms.mu.RUnlock()
	return ms.counter
}

func TestConstantinople(t *testing.T) {
	require := require.New(t)
	testValidateBlockchain := func(cfg config.Config, t *testing.T) {
		ctx := context.Background()

		registry := protocol.NewRegistry()
		// Create a blockchain from scratch
		sf, err := factory.NewFactory(cfg, factory.DefaultTrieOption(), factory.RegistryOption(registry))
		require.NoError(err)
		ap, err := actpool.NewActPool(sf, cfg.ActPool)
		require.NoError(err)
		acc := account.NewProtocol(rewarding.DepositGas)
		require.NoError(acc.Register(registry))
		rp := rolldpos.NewProtocol(cfg.Genesis.NumCandidateDelegates, cfg.Genesis.NumDelegates, cfg.Genesis.NumSubEpochs)
		require.NoError(rp.Register(registry))
		// create indexer
		cfg.DB.DbPath = cfg.Chain.IndexDBPath
		indexer, err := blockindex.NewIndexer(db.NewBoltDB(cfg.DB), cfg.Genesis.Hash())
		require.NoError(err)
		// create BlockDAO
		cfg.DB.DbPath = cfg.Chain.ChainDBPath
		dao := blockdao.NewBlockDAO(db.NewBoltDB(cfg.DB), []blockdao.BlockIndexer{sf, indexer}, cfg.Chain.CompressBlock, cfg.DB)
		require.NotNil(dao)
		bc := blockchain.NewBlockchain(
			cfg,
			dao,
			factory.NewMinter(sf, ap),
			blockchain.BlockValidatorOption(block.NewValidator(
				sf,
				protocol.NewGenericValidator(sf, accountutil.AccountState),
			)),
		)
		ep := execution.NewProtocol(dao.GetBlockHash, rewarding.DepositGas)
		require.NoError(ep.Register(registry))
		rewardingProtocol := rewarding.NewProtocol(0, 0)
		require.NoError(rewardingProtocol.Register(registry))
		require.NoError(bc.Start(ctx))
		defer func() {
			require.NoError(bc.Stop(ctx))
		}()

		require.NoError(addTestingConstantinopleBlocks(bc, dao, sf, ap))

		// reason to use hard-coded hash value here:
		// this test TestConstantinople() is added when we upgrade our EVM to enable Constantinople
		// at that time, the test is run with both EVM version (Byzantium vs. Constantinople), and it generates the
		// same exact block hash, so these values stood as gatekeeper for backward-compatibility
		hashTopic := []struct {
			h       hash.Hash256
			blkHash string
			topic   []byte
		}{
			{
				deployHash,
				"2861aecf2b3f91822de00c9f42ca44276e386ac693df363770783bfc133346c3",
				nil,
			},
			{
				setHash,
				"cb0f7895c1fa4f179c0c109835b160d9d1852fce526e12c6b443e86257cadb48",
				setTopic,
			},
			{
				shrHash,
				"c1337e26e157426dd0af058ed37e329d25dd3e34ed606994a6776b59f988f458",
				shrTopic,
			},
			{
				shlHash,
				"cf5c2050a261fa7eca45f31a184c6cd1dc737c7fc3088a0983f659b08985521c",
				shlTopic,
			},
			{
				sarHash,
				"5d76bd9e4be3a60c00761fd141da6bd9c07ab73f472f537845b65679095b0570",
				sarTopic,
			},
			{
				extHash,
				"c5fd9f372b89265f2423737a6d7b680e9759a4a715b22b04ccf875460c310015",
				extTopic,
			},
			{
				crt2Hash,
				"53632287a97e4e118302f2d9b54b3f97f62d3533286c4d4eb955627b3602d3b0",
				crt2Topic,
			},
		}

		// test getReceipt
		for i := range hashTopic {
			actHash := hashTopic[i].h
			ai, err := indexer.GetActionIndex(actHash[:])
			require.NoError(err)
			r, err := dao.GetReceiptByActionHash(actHash, ai.BlockHeight())
			require.NoError(err)
			require.NotNil(r)
			require.Equal(uint64(1), r.Status)
			require.Equal(actHash, r.ActionHash)
			require.Equal(uint64(i)+1, r.BlockHeight)
			a, err := dao.GetActionByActionHash(actHash, ai.BlockHeight())
			require.NoError(err)
			require.NotNil(a)
			require.Equal(actHash, a.Hash())

			actIndex, err := indexer.GetActionIndex(actHash[:])
			require.NoError(err)
			blkHash, err := dao.GetBlockHash(actIndex.BlockHeight())
			require.NoError(err)
			require.Equal(hashTopic[i].blkHash, hex.EncodeToString(blkHash[:]))

			if hashTopic[i].topic != nil {
				funcSig := hash.Hash256b([]byte("Set(uint256)"))
				blk, err := dao.GetBlockByHeight(1 + uint64(i))
				require.NoError(err)
				f := blk.Header.LogsBloomfilter()
				require.NotNil(f)
				require.True(f.Exist(funcSig[:]))
				require.True(f.Exist(hashTopic[i].topic))
			}
		}

		storeOutGasTests := []struct {
			height      uint64
			actHash     hash.Hash256
			status      iotextypes.ReceiptStatus
			preBalance  *big.Int
			postBalance *big.Int
		}{
			{
				8, storeHash, iotextypes.ReceiptStatus_ErrCodeStoreOutOfGas, preGrPreStore, preGrPostStore,
			},
			{
				9, store2Hash, iotextypes.ReceiptStatus_ErrCodeStoreOutOfGas, preGrPostStore, postGrPostStore,
			},
		}
		caller := identityset.Address(27)
		for _, v := range storeOutGasTests {
			r, err := dao.GetReceiptByActionHash(v.actHash, v.height)
			require.NoError(err)
			require.EqualValues(v.status, r.Status)

			// verify transaction log
			bLog, err := dao.TransactionLogs(v.height)
			require.NoError(err)
			tLog := bLog.Logs[0]
			// first transaction log is gas fee
			tx := tLog.Transactions[0]
			require.Equal(tx.Sender, caller.String())
			require.Equal(tx.Recipient, address.RewardingPoolAddr)
			require.Equal(iotextypes.TransactionLogType_GAS_FEE, tx.Type)
			gasFee, ok := new(big.Int).SetString(tx.Amount, 10)
			require.True(ok)
			postBalance := new(big.Int).Sub(v.preBalance, gasFee)

			hu := config.NewHeightUpgrade(&cfg.Genesis)
			if hu.IsPre(config.Greenland, v.height) {
				// pre-Greenland contains a tx with status = ReceiptStatus_ErrCodeStoreOutOfGas
				// due to a bug the transfer is not reverted
				require.Equal(3, len(tLog.Transactions))
				// 2nd log is in-contract-transfer
				tx = tLog.Transactions[1]
				require.Equal(tx.Sender, caller.String())
				require.Equal(iotextypes.TransactionLogType_IN_CONTRACT_TRANSFER, tx.Type)
				tsfAmount, ok := new(big.Int).SetString(tx.Amount, 10)
				require.True(ok)
				postBalance.Sub(postBalance, tsfAmount)
				// post = pre - gasFee - in_contract_transfer
				require.Equal(v.postBalance, postBalance)
				// 3rd log is also in-contract-transfer
				tx = tLog.Transactions[2]
				require.Equal(tx.Recipient, caller.String())
				require.Equal(iotextypes.TransactionLogType_IN_CONTRACT_TRANSFER, tx.Type)
			} else {
				// post-Greenland fixed that bug, the transfer is reverted so it only contains the gas fee
				require.Equal(1, len(tLog.Transactions))
				// post = pre - gasFee (transfer is reverted)
				require.Equal(v.postBalance, postBalance)
			}
		}

		// test getActions
		addr27 := hash.BytesToHash160(caller.Bytes())
		total, err := indexer.GetActionCountByAddress(addr27)
		require.NoError(err)
		require.EqualValues(len(hashTopic)+len(storeOutGasTests), total)
		actions, err := indexer.GetActionsByAddress(addr27, 0, total)
		require.NoError(err)
		require.EqualValues(total, len(actions))
		for i := range hashTopic {
			require.Equal(hashTopic[i].h[:], actions[i])
		}
		for i := range storeOutGasTests {
			require.Equal(storeOutGasTests[i].actHash[:], actions[i+len(hashTopic)])
		}
	}

	cfg := config.Default
	testTriePath, err := testutil.PathOfTempFile("trie")
	require.NoError(err)
	testDBPath, err := testutil.PathOfTempFile("db")
	require.NoError(err)
	testIndexPath, err := testutil.PathOfTempFile("index")
	require.NoError(err)

	defer func() {
		testutil.CleanupPath(t, testTriePath)
		testutil.CleanupPath(t, testDBPath)
		testutil.CleanupPath(t, testIndexPath)
		// clear the gateway
		delete(cfg.Plugins, config.GatewayPlugin)
	}()

	cfg.Chain.TrieDBPath = testTriePath
	cfg.Chain.ChainDBPath = testDBPath
	cfg.Chain.IndexDBPath = testIndexPath
	cfg.Chain.ProducerPrivKey = "a000000000000000000000000000000000000000000000000000000000000000"
	cfg.Genesis.EnableGravityChainVoting = false
	cfg.Plugins[config.GatewayPlugin] = true
	cfg.Chain.EnableAsyncIndexWrite = false
	cfg.ActPool.MinGasPriceStr = "0"
	cfg.Genesis.AleutianBlockHeight = 2
	cfg.Genesis.BeringBlockHeight = 8
	cfg.Genesis.GreenlandBlockHeight = 9
	cfg.Genesis.InitBalanceMap[identityset.Address(27).String()] = unit.ConvertIotxToRau(10000000000).String()

	t.Run("test Constantinople contract", func(t *testing.T) {
		testValidateBlockchain(cfg, t)
	})
}

func TestLoadBlockchainfromDB(t *testing.T) {
	require := require.New(t)
	testValidateBlockchain := func(cfg config.Config, t *testing.T) {
		ctx := context.Background()

		registry := protocol.NewRegistry()
		// Create a blockchain from scratch
		sf, err := factory.NewFactory(cfg, factory.DefaultTrieOption(), factory.RegistryOption(registry))
		require.NoError(err)
		ap, err := actpool.NewActPool(sf, cfg.ActPool)
		require.NoError(err)
		acc := account.NewProtocol(rewarding.DepositGas)
		require.NoError(acc.Register(registry))
		rp := rolldpos.NewProtocol(cfg.Genesis.NumCandidateDelegates, cfg.Genesis.NumDelegates, cfg.Genesis.NumSubEpochs)
		require.NoError(rp.Register(registry))
		var indexer blockindex.Indexer
		indexers := []blockdao.BlockIndexer{sf}
		if _, gateway := cfg.Plugins[config.GatewayPlugin]; gateway && !cfg.Chain.EnableAsyncIndexWrite {
			// create indexer
			cfg.DB.DbPath = cfg.Chain.IndexDBPath
			indexer, err = blockindex.NewIndexer(db.NewBoltDB(cfg.DB), cfg.Genesis.Hash())
			require.NoError(err)
			indexers = append(indexers, indexer)
		}
		cfg.Genesis.InitBalanceMap[identityset.Address(27).String()] = unit.ConvertIotxToRau(10000000000).String()
		// create BlockDAO
		cfg.DB.DbPath = cfg.Chain.ChainDBPath
		dao := blockdao.NewBlockDAO(db.NewBoltDB(cfg.DB), indexers, cfg.Chain.CompressBlock, cfg.DB)
		require.NotNil(dao)
		bc := blockchain.NewBlockchain(
			cfg,
			dao,
			factory.NewMinter(sf, ap),
			blockchain.BlockValidatorOption(block.NewValidator(
				sf,
				protocol.NewGenericValidator(sf, accountutil.AccountState),
			)),
		)
		ep := execution.NewProtocol(dao.GetBlockHash, rewarding.DepositGas)
		require.NoError(ep.Register(registry))
		require.NoError(bc.Start(ctx))

		ms := &MockSubscriber{counter: 0}
		require.NoError(bc.AddSubscriber(ms))
		require.Equal(0, ms.Counter())

		height := bc.TipHeight()
		fmt.Printf("Open blockchain pass, height = %d\n", height)
		require.NoError(addTestingTsfBlocks(cfg, bc, dao, ap))
		require.NoError(bc.Stop(ctx))
		require.Equal(24, ms.Counter())

		// Load a blockchain from DB
		bc = blockchain.NewBlockchain(
			cfg,
			dao,
			factory.NewMinter(sf, ap),
			blockchain.BlockValidatorOption(block.NewValidator(
				sf,
				protocol.NewGenericValidator(sf, accountutil.AccountState),
			)),
		)
		require.NoError(bc.Start(ctx))
		defer func() {
			require.NoError(bc.Stop(ctx))
		}()

		// verify block header hash
		for i := uint64(1); i <= 5; i++ {
			hash, err := dao.GetBlockHash(i)
			require.NoError(err)
			height, err = dao.GetBlockHeight(hash)
			require.NoError(err)
			require.Equal(i, height)
			header, err := bc.BlockHeaderByHeight(height)
			require.NoError(err)
			require.Equal(height, header.Height())

			// bloomfilter only exists after aleutian height
			require.Equal(height >= cfg.Genesis.AleutianBlockHeight, header.LogsBloomfilter() != nil)
		}

		empblk, err := dao.GetBlock(hash.ZeroHash256)
		require.Nil(empblk)
		require.Error(err)

		header, err := bc.BlockHeaderByHeight(60000)
		require.Nil(header)
		require.Error(err)

		// add wrong blocks
		h := bc.TipHeight()
		blkhash := bc.TipHash()
		header, err = bc.BlockHeaderByHeight(h)
		require.NoError(err)
		require.Equal(blkhash, header.HashBlock())
		fmt.Printf("Current tip = %d hash = %x\n", h, blkhash)

		// add block with wrong height
		selp, err := testutil.SignedTransfer(identityset.Address(29).String(), identityset.PrivateKey(27), 1, big.NewInt(50), nil, genesis.Default.ActionGasLimit, big.NewInt(0))
		require.NoError(err)

		nblk, err := block.NewTestingBuilder().
			SetHeight(h + 2).
			SetPrevBlockHash(blkhash).
			SetTimeStamp(testutil.TimestampNow()).
			AddActions(selp).SignAndBuild(identityset.PrivateKey(29))
		require.NoError(err)

		require.Error(bc.ValidateBlock(&nblk))
		fmt.Printf("Cannot validate block %d: %v\n", header.Height(), err)

		// add block with zero prev hash
		selp2, err := testutil.SignedTransfer(identityset.Address(29).String(), identityset.PrivateKey(27), 1, big.NewInt(50), nil, genesis.Default.ActionGasLimit, big.NewInt(0))
		require.NoError(err)

		nblk, err = block.NewTestingBuilder().
			SetHeight(h + 1).
			SetPrevBlockHash(hash.ZeroHash256).
			SetTimeStamp(testutil.TimestampNow()).
			AddActions(selp2).SignAndBuild(identityset.PrivateKey(29))
		require.NoError(err)
		err = bc.ValidateBlock(&nblk)
		require.Error(err)
		fmt.Printf("Cannot validate block %d: %v\n", header.Height(), err)

		// add existing block again will have no effect
		blk, err := dao.GetBlockByHeight(3)
		require.NotNil(blk)
		require.NoError(err)
		require.NoError(bc.CommitBlock(blk))
		fmt.Printf("Cannot add block 3 again: %v\n", err)

		// invalid address returns error
		act, err := accountutil.AccountState(sf, "")
		require.Equal("invalid bech32 string length 0", errors.Cause(err).Error())
		require.Nil(act)

		// valid but unused address should return empty account
		act, err = accountutil.AccountState(sf, "io1066kus4vlyvk0ljql39fzwqw0k22h7j8wmef3n")
		require.NoError(err)
		require.Equal(uint64(0), act.Nonce)
		require.Equal(big.NewInt(0), act.Balance)

		_, gateway := cfg.Plugins[config.GatewayPlugin]
		if gateway && !cfg.Chain.EnableAsyncIndexWrite {
			// verify deployed contract
			ai, err := indexer.GetActionIndex(deployHash[:])
			require.NoError(err)
			r, err := dao.GetReceiptByActionHash(deployHash, ai.BlockHeight())
			require.NoError(err)
			require.NotNil(r)
			require.Equal(uint64(1), r.Status)
			require.Equal(uint64(2), r.BlockHeight)

			// 2 topics in block 3 calling set()
			funcSig := hash.Hash256b([]byte("Set(uint256)"))
			blk, err := dao.GetBlockByHeight(3)
			require.NoError(err)
			f := blk.Header.LogsBloomfilter()
			require.NotNil(f)
			require.True(f.Exist(funcSig[:]))
			require.True(f.Exist(setTopic))

			// 3 topics in block 4 calling get()
			funcSig = hash.Hash256b([]byte("Get(address,uint256)"))
			blk, err = dao.GetBlockByHeight(4)
			require.NoError(err)
			f = blk.Header.LogsBloomfilter()
			require.NotNil(f)
			require.True(f.Exist(funcSig[:]))
			require.True(f.Exist(setTopic))
			require.True(f.Exist(getTopic))

			// verify genesis block index
			bi, err := indexer.GetBlockIndex(0)
			require.NoError(err)
			require.Equal(cfg.Genesis.Hash(), hash.BytesToHash256(bi.Hash()))
			require.EqualValues(0, bi.NumAction())
			require.Equal(big.NewInt(0), bi.TsfAmount())

			for h := uint64(1); h <= 5; h++ {
				// verify getting number of actions
				blk, err = dao.GetBlockByHeight(h)
				require.NoError(err)
				blkIndex, err := indexer.GetBlockIndex(h)
				require.NoError(err)
				require.EqualValues(blkIndex.NumAction(), len(blk.Actions))

				// verify getting transfer amount
				tsfs, _ := action.ClassifyActions(blk.Actions)
				tsfa := big.NewInt(0)
				for _, tsf := range tsfs {
					tsfa.Add(tsfa, tsf.Amount())
				}
				require.Equal(blkIndex.TsfAmount(), tsfa)
			}
		}
	}

	testTriePath, err := testutil.PathOfTempFile("trie")
	require.NoError(err)
	testDBPath, err := testutil.PathOfTempFile("db")
	require.NoError(err)
	testIndexPath, err := testutil.PathOfTempFile("index")
	require.NoError(err)

	defer func() {
		testutil.CleanupPath(t, testTriePath)
		testutil.CleanupPath(t, testDBPath)
		testutil.CleanupPath(t, testIndexPath)
	}()

	cfg := config.Default
	cfg.Chain.TrieDBPath = testTriePath
	cfg.Chain.ChainDBPath = testDBPath
	cfg.Chain.IndexDBPath = testIndexPath
	cfg.Genesis.EnableGravityChainVoting = false
	cfg.ActPool.MinGasPriceStr = "0"

	t.Run("load blockchain from DB w/o explorer", func(t *testing.T) {
		// testValidateBlockchain(cfg, t)
	})

	testTriePath2, err := testutil.PathOfTempFile("trie")
	require.NoError(err)
	testDBPath2, err := testutil.PathOfTempFile("db")
	require.NoError(err)
	testIndexPath2, err := testutil.PathOfTempFile("index")
	require.NoError(err)

	defer func() {
		testutil.CleanupPath(t, testTriePath2)
		testutil.CleanupPath(t, testDBPath2)
		testutil.CleanupPath(t, testIndexPath2)
		// clear the gateway
		delete(cfg.Plugins, config.GatewayPlugin)
	}()

	cfg.Plugins[config.GatewayPlugin] = true
	cfg.Chain.TrieDBPath = testTriePath2
	cfg.Chain.ChainDBPath = testDBPath2
	cfg.Chain.IndexDBPath = testIndexPath2
	// test using sm2 signature
	cfg.Chain.SignatureScheme = []string{config.SigP256sm2}
	cfg.Chain.ProducerPrivKey = "308193020100301306072a8648ce3d020106082a811ccf5501822d0479307702010104202d57ec7da578b98dad465997748ed02af0c69092ad809598073e5a2356c20492a00a06082a811ccf5501822da14403420004223356f0c6f40822ade24d47b0cd10e9285402cbc8a5028a8eec9efba44b8dfe1a7e8bc44953e557b32ec17039fb8018a58d48c8ffa54933fac8030c9a169bf6"
	cfg.Chain.EnableAsyncIndexWrite = false
	cfg.Genesis.AleutianBlockHeight = 3

	t.Run("load blockchain from DB", func(t *testing.T) {
		testValidateBlockchain(cfg, t)
	})
}

func TestBlockchainInitialCandidate(t *testing.T) {
	require := require.New(t)

	testTriePath, err := testutil.PathOfTempFile("trie")
	require.NoError(err)
	testDBPath, err := testutil.PathOfTempFile("db")
	require.NoError(err)
	testIndexPath, err := testutil.PathOfTempFile("index")
	require.NoError(err)

	cfg := config.Default
	cfg.Chain.TrieDBPath = testTriePath
	cfg.Chain.ChainDBPath = testDBPath
	cfg.Chain.IndexDBPath = testIndexPath
	cfg.Consensus.Scheme = config.RollDPoSScheme
	registry := protocol.NewRegistry()
	sf, err := factory.NewFactory(cfg, factory.DefaultTrieOption(), factory.RegistryOption(registry))
	require.NoError(err)
	ap, err := actpool.NewActPool(sf, cfg.ActPool)
	require.NoError(err)
	accountProtocol := account.NewProtocol(rewarding.DepositGas)
	require.NoError(accountProtocol.Register(registry))
	bc := blockchain.NewBlockchain(
		cfg,
		nil,
		factory.NewMinter(sf, ap),
		blockchain.BoltDBDaoOption(sf),
		blockchain.BlockValidatorOption(sf),
	)
	rolldposProtocol := rolldpos.NewProtocol(
		genesis.Default.NumCandidateDelegates,
		genesis.Default.NumDelegates,
		genesis.Default.NumSubEpochs,
	)
	require.NoError(rolldposProtocol.Register(registry))
	rewardingProtocol := rewarding.NewProtocol(0, 0)
	require.NoError(rewardingProtocol.Register(registry))
	pollProtocol := poll.NewLifeLongDelegatesProtocol(cfg.Genesis.Delegates)
	require.NoError(pollProtocol.Register(registry))

	require.NoError(bc.Start(context.Background()))
	defer func() {
		require.NoError(bc.Stop(context.Background()))
	}()
	candidate, _, err := candidatesutil.CandidatesFromDB(sf, 1, true, false)
	require.NoError(err)
	require.Equal(24, len(candidate))
}

func TestBlockchain_AccountState(t *testing.T) {
	require := require.New(t)

	cfg := config.Default
	// disable account-based testing
	// create chain
	cfg.Genesis.InitBalanceMap[identityset.Address(0).String()] = "100"
	registry := protocol.NewRegistry()
	acc := account.NewProtocol(rewarding.DepositGas)
	require.NoError(acc.Register(registry))
	sf, err := factory.NewFactory(cfg, factory.InMemTrieOption(), factory.RegistryOption(registry))
	require.NoError(err)
	ap, err := actpool.NewActPool(sf, cfg.ActPool)
	require.NoError(err)
	bc := blockchain.NewBlockchain(cfg, nil, factory.NewMinter(sf, ap), blockchain.InMemDaoOption(sf))
	require.NoError(bc.Start(context.Background()))
	require.NotNil(bc)
	s, err := accountutil.AccountState(sf, identityset.Address(0).String())
	require.NoError(err)
	require.Equal(uint64(0), s.Nonce)
	require.Equal(big.NewInt(100), s.Balance)
	require.Equal(hash.ZeroHash256, s.Root)
	require.Equal([]byte(nil), s.CodeHash)
}

func TestBlocks(t *testing.T) {
	// This test is used for committing block verify benchmark purpose
	t.Skip()
	require := require.New(t)
	cfg := config.Default

	testTriePath, err := testutil.PathOfTempFile("trie")
	require.NoError(err)
	testDBPath, err := testutil.PathOfTempFile("db")
	require.NoError(err)
	testIndexPath, err := testutil.PathOfTempFile("index")
	require.NoError(err)

	a := identityset.Address(28).String()
	priKeyA := identityset.PrivateKey(28)
	c := identityset.Address(29).String()

	cfg.Chain.TrieDBPath = testTriePath
	cfg.Chain.ChainDBPath = testDBPath
	cfg.Chain.IndexDBPath = testIndexPath
	cfg.Genesis.InitBalanceMap[identityset.Address(27).String()] = unit.ConvertIotxToRau(10000000000).String()
	cfg.Genesis.InitBalanceMap[a] = "100000"
	cfg.Genesis.InitBalanceMap[c] = "100000"

	registry := protocol.NewRegistry()
	acc := account.NewProtocol(rewarding.DepositGas)
	require.NoError(acc.Register(registry))
	sf, err := factory.NewFactory(cfg, factory.InMemTrieOption(), factory.RegistryOption(registry))
	require.NoError(err)
	ap, err := actpool.NewActPool(sf, cfg.ActPool)
	require.NoError(err)

	// Create a blockchain from scratch
	bc := blockchain.NewBlockchain(cfg, nil, factory.NewMinter(sf, ap), blockchain.BoltDBDaoOption(sf))
	require.NoError(bc.Start(context.Background()))
	defer func() {
		require.NoError(bc.Stop(context.Background()))
	}()

	gasLimit := testutil.TestGasLimit
	ctx := protocol.WithBlockCtx(context.Background(),
		protocol.BlockCtx{
			Producer: identityset.Address(27),
			GasLimit: gasLimit,
		})
	ctx = protocol.WithBlockchainCtx(ctx,
		protocol.BlockchainCtx{
			Genesis: cfg.Genesis,
		})

	for i := 0; i < 10; i++ {
		actionMap := make(map[string][]action.SealedEnvelope)
		actionMap[a] = []action.SealedEnvelope{}
		for i := 0; i < 1000; i++ {
			tsf, err := testutil.SignedTransfer(c, priKeyA, 1, big.NewInt(2), []byte{}, testutil.TestGasLimit, big.NewInt(testutil.TestGasPriceInt64))
			require.NoError(err)
			require.NoError(ap.Add(context.Background(), tsf))
		}
		blk, _ := bc.MintNewBlock(testutil.TimestampNow())
		require.NoError(bc.CommitBlock(blk))
	}
}

func TestActions(t *testing.T) {
	// This test is used for block verify benchmark purpose
	t.Skip()
	require := require.New(t)
	cfg := config.Default

	registry := protocol.NewRegistry()
	acc := account.NewProtocol(rewarding.DepositGas)
	require.NoError(acc.Register(registry))

	ctx := protocol.WithBlockchainCtx(
		protocol.WithRegistry(context.Background(), registry),
		protocol.BlockchainCtx{Genesis: cfg.Genesis},
	)

	testTriePath, err := testutil.PathOfTempFile("trie")
	require.NoError(err)
	testDBPath, err := testutil.PathOfTempFile("db")
	require.NoError(err)
	testIndexPath, err := testutil.PathOfTempFile("index")
	require.NoError(err)

	a := identityset.Address(28).String()
	priKeyA := identityset.PrivateKey(28)
	c := identityset.Address(29).String()

	cfg.Chain.TrieDBPath = testTriePath
	cfg.Chain.ChainDBPath = testDBPath
	cfg.Chain.IndexDBPath = testIndexPath
	cfg.Genesis.InitBalanceMap[identityset.Address(27).String()] = unit.ConvertIotxToRau(10000000000).String()
	cfg.Genesis.InitBalanceMap[a] = "100000"
	cfg.Genesis.InitBalanceMap[c] = "100000"

	sf, err := factory.NewFactory(cfg, factory.InMemTrieOption(), factory.RegistryOption(registry))
	require.NoError(err)
	ap, err := actpool.NewActPool(sf, cfg.ActPool)
	require.NoError(err)
	// Create a blockchain from scratch
	bc := blockchain.NewBlockchain(
		cfg,
		nil,
		factory.NewMinter(sf, ap),
		blockchain.BoltDBDaoOption(sf),
		blockchain.BlockValidatorOption(block.NewValidator(
			sf,
			protocol.NewGenericValidator(sf, accountutil.AccountState),
		)),
	)
	require.NoError(bc.Start(context.Background()))
	defer func() {
		require.NoError(bc.Stop(context.Background()))
	}()

	gasLimit := testutil.TestGasLimit
	ctx = protocol.WithBlockCtx(context.Background(),
		protocol.BlockCtx{
			Producer: identityset.Address(27),
			GasLimit: gasLimit,
		})
	ctx = protocol.WithBlockchainCtx(ctx,
		protocol.BlockchainCtx{
			Genesis: cfg.Genesis,
		})

	for i := 0; i < 5000; i++ {
		tsf, err := testutil.SignedTransfer(c, priKeyA, 1, big.NewInt(2), []byte{}, testutil.TestGasLimit, big.NewInt(testutil.TestGasPriceInt64))
		require.NoError(err)
		require.NoError(ap.Add(context.Background(), tsf))

		tsf2, err := testutil.SignedTransfer(a, priKeyA, 1, big.NewInt(2), []byte{}, testutil.TestGasLimit, big.NewInt(testutil.TestGasPriceInt64))
		require.NoError(err)
		require.NoError(ap.Add(context.Background(), tsf2))
	}
	blk, _ := bc.MintNewBlock(testutil.TimestampNow())
	ctx = protocol.WithBlockchainCtx(
		ctx,
		protocol.BlockchainCtx{
			Genesis: cfg.Genesis,
			Tip: protocol.TipInfo{
				Height: 0,
				Hash:   blk.PrevHash(),
			},
		},
	)
	require.NoError(bc.ValidateBlock(blk))
}

func TestBlockchain_AddSubscriber(t *testing.T) {
	req := require.New(t)
	cfg := config.Default
	cfg.Genesis.BlockGasLimit = uint64(100000)
	cfg.Genesis.EnableGravityChainVoting = false
	// create chain
	registry := protocol.NewRegistry()
	sf, err := factory.NewFactory(cfg, factory.InMemTrieOption(), factory.RegistryOption(registry))
	req.NoError(err)
	ap, err := actpool.NewActPool(sf, cfg.ActPool)
	req.NoError(err)
	bc := blockchain.NewBlockchain(cfg, nil, factory.NewMinter(sf, ap), blockchain.InMemDaoOption(sf))
	// mock
	ctrl := gomock.NewController(t)
	defer ctrl.Finish()
	mb := mock_blockcreationsubscriber.NewMockBlockCreationSubscriber(ctrl)
	req.NoError(bc.AddSubscriber(mb))
	req.EqualError(bc.AddSubscriber(nil), "subscriber could not be nil")
}

func TestBlockchain_RemoveSubscriber(t *testing.T) {
	req := require.New(t)
	cfg := config.Default
	cfg.Genesis.BlockGasLimit = uint64(100000)
	cfg.Genesis.EnableGravityChainVoting = false
	// create chain
	registry := protocol.NewRegistry()
	sf, err := factory.NewFactory(cfg, factory.InMemTrieOption(), factory.RegistryOption(registry))
	req.NoError(err)
	ap, err := actpool.NewActPool(sf, cfg.ActPool)
	req.NoError(err)
	bc := blockchain.NewBlockchain(cfg, nil, factory.NewMinter(sf, ap), blockchain.InMemDaoOption(sf))
	// mock
	ctrl := gomock.NewController(t)
	defer ctrl.Finish()
	mb := mock_blockcreationsubscriber.NewMockBlockCreationSubscriber(ctrl)
	req.Error(bc.RemoveSubscriber(mb))
	req.NoError(bc.AddSubscriber(mb))
	req.NoError(bc.RemoveSubscriber(mb))
	req.EqualError(bc.RemoveSubscriber(nil), "cannot find subscription")
}

func TestHistoryForAccount(t *testing.T) {
	testHistoryForAccount(t, false)
	testHistoryForAccount(t, true)
}

func testHistoryForAccount(t *testing.T, statetx bool) {
	require := require.New(t)
	bc, sf, _, _, ap := newChain(t, statetx)
	a := identityset.Address(28).String()
	priKeyA := identityset.PrivateKey(28)
	b := identityset.Address(29).String()

	// check the original balance a and b before transfer
	AccountA, err := accountutil.AccountState(sf, a)
	require.NoError(err)
	AccountB, err := accountutil.AccountState(sf, b)
	require.NoError(err)
	require.Equal(big.NewInt(100), AccountA.Balance)
	require.Equal(big.NewInt(100), AccountB.Balance)

	// make a transfer from a to b
	actionMap := make(map[string][]action.SealedEnvelope)
	actionMap[a] = []action.SealedEnvelope{}
	tsf, err := testutil.SignedTransfer(b, priKeyA, 1, big.NewInt(10), []byte{}, testutil.TestGasLimit, big.NewInt(testutil.TestGasPriceInt64))
	require.NoError(err)
	require.NoError(ap.Add(context.Background(), tsf))
	blk, err := bc.MintNewBlock(testutil.TimestampNow())
	require.NoError(err)
	require.NoError(bc.ValidateBlock(blk))
	require.NoError(bc.CommitBlock(blk))

	// check balances after transfer
	AccountA, err = accountutil.AccountState(sf, a)
	require.NoError(err)
	AccountB, err = accountutil.AccountState(sf, b)
	require.NoError(err)
	require.Equal(big.NewInt(90), AccountA.Balance)
	require.Equal(big.NewInt(110), AccountB.Balance)

	// check history account's balance
	if statetx {
		_, err = accountutil.AccountState(factory.NewHistoryStateReader(sf, bc.TipHeight()-1), a)
		require.Equal(factory.ErrNotSupported, errors.Cause(err))
		_, err = accountutil.AccountState(factory.NewHistoryStateReader(sf, bc.TipHeight()-1), b)
		require.Equal(factory.ErrNotSupported, errors.Cause(err))
	} else {
		AccountA, err = accountutil.AccountState(factory.NewHistoryStateReader(sf, bc.TipHeight()-1), a)
		require.NoError(err)
		AccountB, err = accountutil.AccountState(factory.NewHistoryStateReader(sf, bc.TipHeight()-1), b)
		require.NoError(err)
		require.Equal(big.NewInt(100), AccountA.Balance)
		require.Equal(big.NewInt(100), AccountB.Balance)
	}
}

func TestHistoryForContract(t *testing.T) {
	testHistoryForContract(t, false)
	testHistoryForContract(t, true)
}

func testHistoryForContract(t *testing.T, statetx bool) {
	require := require.New(t)
	bc, sf, kv, dao, ap := newChain(t, statetx)
	genesisAccount := identityset.Address(27).String()
	// deploy and get contract address
	contract := deployXrc20(bc, dao, ap, t)

	account, err := accountutil.AccountState(sf, contract)
	require.NoError(err)
	// check the original balance
	balance := BalanceOfContract(contract, genesisAccount, kv, t, account.Root)
	expect, ok := big.NewInt(0).SetString("2000000000000000000000000000", 10)
	require.True(ok)
	require.Equal(expect, balance)
	// make a transfer for contract
	makeTransfer(contract, bc, ap, t)
	account, err = accountutil.AccountState(sf, contract)
	require.NoError(err)
	// check the balance after transfer
	balance = BalanceOfContract(contract, genesisAccount, kv, t, account.Root)
	expect, ok = big.NewInt(0).SetString("1999999999999999999999999999", 10)
	require.True(ok)
	require.Equal(expect, balance)

	// check the the original balance again
	if statetx {
		_, err = accountutil.AccountState(factory.NewHistoryStateReader(sf, bc.TipHeight()-1), contract)
		require.True(errors.Cause(err) == factory.ErrNotSupported)
	} else {
		account, err = accountutil.AccountState(factory.NewHistoryStateReader(sf, bc.TipHeight()-1), contract)
		require.NoError(err)
		balance = BalanceOfContract(contract, genesisAccount, kv, t, account.Root)
		expect, ok = big.NewInt(0).SetString("2000000000000000000000000000", 10)
		require.True(ok)
		require.Equal(expect, balance)
	}
}

func deployXrc20(bc blockchain.Blockchain, dao blockdao.BlockDAO, ap actpool.ActPool, t *testing.T) string {
	require := require.New(t)
	genesisPriKey := identityset.PrivateKey(27)
	// deploy a xrc20 contract with balance 2000000000000000000000000000
	data, err := hex.DecodeString("60806040526002805460ff1916601217905534801561001d57600080fd5b506040516107cd3803806107cd83398101604090815281516020808401518385015160025460ff16600a0a84026003819055336000908152600485529586205590850180519395909491019261007592850190610092565b508051610089906001906020840190610092565b5050505061012d565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106100d357805160ff1916838001178555610100565b82800160010185558215610100579182015b828111156101005782518255916020019190600101906100e5565b5061010c929150610110565b5090565b61012a91905b8082111561010c5760008155600101610116565b90565b6106918061013c6000396000f3006080604052600436106100ae5763ffffffff7c010000000000000000000000000000000000000000000000000000000060003504166306fdde0381146100b3578063095ea7b31461013d57806318160ddd1461017557806323b872dd1461019c578063313ce567146101c657806342966c68146101f1578063670d14b21461020957806370a082311461022a57806395d89b411461024b578063a9059cbb14610260578063dd62ed3e14610286575b600080fd5b3480156100bf57600080fd5b506100c86102ad565b6040805160208082528351818301528351919283929083019185019080838360005b838110156101025781810151838201526020016100ea565b50505050905090810190601f16801561012f5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34801561014957600080fd5b50610161600160a060020a036004351660243561033b565b604080519115158252519081900360200190f35b34801561018157600080fd5b5061018a610368565b60408051918252519081900360200190f35b3480156101a857600080fd5b50610161600160a060020a036004358116906024351660443561036e565b3480156101d257600080fd5b506101db6103dd565b6040805160ff9092168252519081900360200190f35b3480156101fd57600080fd5b506101616004356103e6565b34801561021557600080fd5b506100c8600160a060020a036004351661045e565b34801561023657600080fd5b5061018a600160a060020a03600435166104c6565b34801561025757600080fd5b506100c86104d8565b34801561026c57600080fd5b50610284600160a060020a0360043516602435610532565b005b34801561029257600080fd5b5061018a600160a060020a0360043581169060243516610541565b6000805460408051602060026001851615610100026000190190941693909304601f810184900484028201840190925281815292918301828280156103335780601f1061030857610100808354040283529160200191610333565b820191906000526020600020905b81548152906001019060200180831161031657829003601f168201915b505050505081565b336000908152600560209081526040808320600160a060020a039590951683529390529190912055600190565b60035481565b600160a060020a038316600090815260056020908152604080832033845290915281205482111561039e57600080fd5b600160a060020a03841660009081526005602090815260408083203384529091529020805483900390556103d384848461055e565b5060019392505050565b60025460ff1681565b3360009081526004602052604081205482111561040257600080fd5b3360008181526004602090815260409182902080548690039055600380548690039055815185815291517fcc16f5dbb4873280815c1ee09dbd06736cffcc184412cf7a71a0fdb75d397ca59281900390910190a2506001919050565b60066020908152600091825260409182902080548351601f6002600019610100600186161502019093169290920491820184900484028101840190945280845290918301828280156103335780601f1061030857610100808354040283529160200191610333565b60046020526000908152604090205481565b60018054604080516020600284861615610100026000190190941693909304601f810184900484028201840190925281815292918301828280156103335780601f1061030857610100808354040283529160200191610333565b61053d33838361055e565b5050565b600560209081526000928352604080842090915290825290205481565b6000600160a060020a038316151561057557600080fd5b600160a060020a03841660009081526004602052604090205482111561059a57600080fd5b600160a060020a038316600090815260046020526040902054828101116105c057600080fd5b50600160a060020a038083166000818152600460209081526040808320805495891680855282852080548981039091559486905281548801909155815187815291519390950194927fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef929181900390910190a3600160a060020a0380841660009081526004602052604080822054928716825290205401811461065f57fe5b505050505600a165627a7a723058207c03ad12a18902cfe387e684509d310abd583d862c11e3ee80c116af8b49ec5c00290000000000000000000000000000000000000000000000000000000077359400000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000004696f7478000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004696f747800000000000000000000000000000000000000000000000000000000")
	require.NoError(err)
	execution, err := action.NewExecution(action.EmptyAddress, 3, big.NewInt(0), 1000000, big.NewInt(testutil.TestGasPriceInt64), data)
	require.NoError(err)
	bd := &action.EnvelopeBuilder{}
	elp := bd.SetAction(execution).
		SetNonce(3).
		SetGasLimit(1000000).
		SetGasPrice(big.NewInt(testutil.TestGasPriceInt64)).Build()
	selp, err := action.Sign(elp, genesisPriKey)
	require.NoError(err)

	require.NoError(ap.Add(context.Background(), selp))

	blk, err := bc.MintNewBlock(testutil.TimestampNow())
	require.NoError(err)
	require.NoError(bc.CommitBlock(blk))
	r, err := dao.GetReceiptByActionHash(selp.Hash(), blk.Height())
	require.NoError(err)
	return r.ContractAddress
}

func BalanceOfContract(contract, genesisAccount string, kv db.KVStore, t *testing.T, root hash.Hash256) *big.Int {
	require := require.New(t)
	addr, err := address.FromString(contract)
	require.NoError(err)
	addrHash := hash.BytesToHash160(addr.Bytes())
	dbForTrie, err := trie.NewKVStore(evm.ContractKVNameSpace, kv)
	require.NoError(err)
	options := []mptrie.Option{
		mptrie.KVStoreOption(dbForTrie),
		mptrie.KeyLengthOption(len(hash.Hash256{})),
		mptrie.HashFuncOption(func(data []byte) []byte {
			h := hash.Hash256b(append(addrHash[:], data...))
			return h[:]
		}),
	}
	options = append(options, mptrie.RootHashOption(root[:]))
	tr, err := mptrie.New(options...)
	require.NoError(err)
	require.NoError(tr.Start(context.Background()))
	defer tr.Stop(context.Background())
	// get producer's xrc20 balance
	addr, err = address.FromString(genesisAccount)
	require.NoError(err)
	addrHash = hash.BytesToHash160(addr.Bytes())
	checkData := "000000000000000000000000" + hex.EncodeToString(addrHash[:]) + "0000000000000000000000000000000000000000000000000000000000000004"
	hb, err := hex.DecodeString(checkData)
	require.NoError(err)
	out2 := crypto.Keccak256(hb)
	ret, err := tr.Get(out2[:])
	require.NoError(err)
	return big.NewInt(0).SetBytes(ret)
}

func newChain(t *testing.T, stateTX bool) (blockchain.Blockchain, factory.Factory, db.KVStore, blockdao.BlockDAO, actpool.ActPool) {
	require := require.New(t)
	cfg := config.Default

	testTriePath, err := testutil.PathOfTempFile("trie")
	require.NoError(err)
	testDBPath, err := testutil.PathOfTempFile("db")
	require.NoError(err)
	testIndexPath, err := testutil.PathOfTempFile("index")
	require.NoError(err)

	cfg.Chain.TrieDBPath = testTriePath
	cfg.Chain.ChainDBPath = testDBPath
	cfg.Chain.IndexDBPath = testIndexPath
	cfg.Chain.EnableArchiveMode = true
	cfg.Consensus.Scheme = config.RollDPoSScheme
	cfg.Genesis.BlockGasLimit = uint64(1000000)
	cfg.ActPool.MinGasPriceStr = "0"
	cfg.Genesis.EnableGravityChainVoting = false
	registry := protocol.NewRegistry()
	var sf factory.Factory
	kv := db.NewMemKVStore()
	if stateTX {
		sf, err = factory.NewStateDB(cfg, factory.PrecreatedStateDBOption(kv), factory.RegistryStateDBOption(registry))
		require.NoError(err)
	} else {
		sf, err = factory.NewFactory(cfg, factory.PrecreatedTrieDBOption(kv), factory.RegistryOption(registry))
		require.NoError(err)
	}
	ap, err := actpool.NewActPool(sf, cfg.ActPool)
	require.NoError(err)
	acc := account.NewProtocol(rewarding.DepositGas)
	require.NoError(acc.Register(registry))
	rp := rolldpos.NewProtocol(cfg.Genesis.NumCandidateDelegates, cfg.Genesis.NumDelegates, cfg.Genesis.NumSubEpochs)
	require.NoError(rp.Register(registry))
	var indexer blockindex.Indexer
	indexers := []blockdao.BlockIndexer{sf}
	if _, gateway := cfg.Plugins[config.GatewayPlugin]; gateway && !cfg.Chain.EnableAsyncIndexWrite {
		// create indexer
		cfg.DB.DbPath = cfg.Chain.IndexDBPath
		indexer, err = blockindex.NewIndexer(db.NewBoltDB(cfg.DB), cfg.Genesis.Hash())
		require.NoError(err)
		indexers = append(indexers, indexer)
	}
	cfg.Genesis.InitBalanceMap[identityset.Address(27).String()] = unit.ConvertIotxToRau(10000000000).String()
	// create BlockDAO
	cfg.DB.DbPath = cfg.Chain.ChainDBPath
	dao := blockdao.NewBlockDAO(db.NewBoltDB(cfg.DB), indexers, cfg.Chain.CompressBlock, cfg.DB)
	require.NotNil(dao)
	bc := blockchain.NewBlockchain(
		cfg,
		dao,
		factory.NewMinter(sf, ap),
		blockchain.BlockValidatorOption(block.NewValidator(
			sf,
			protocol.NewGenericValidator(sf, accountutil.AccountState),
		)),
	)
	require.NotNil(bc)
	ep := execution.NewProtocol(dao.GetBlockHash, rewarding.DepositGas)
	require.NoError(ep.Register(registry))
	require.NoError(bc.Start(context.Background()))

	genesisPriKey := identityset.PrivateKey(27)
	a := identityset.Address(28).String()
	b := identityset.Address(29).String()
	// make a transfer from genesisAccount to a and b,because stateTX cannot store data in height 0
	tsf, err := testutil.SignedTransfer(a, genesisPriKey, 1, big.NewInt(100), []byte{}, testutil.TestGasLimit, big.NewInt(testutil.TestGasPriceInt64))
	require.NoError(err)
	tsf2, err := testutil.SignedTransfer(b, genesisPriKey, 2, big.NewInt(100), []byte{}, testutil.TestGasLimit, big.NewInt(testutil.TestGasPriceInt64))
	require.NoError(err)
	require.NoError(ap.Add(context.Background(), tsf))
	require.NoError(ap.Add(context.Background(), tsf2))
	blk, err := bc.MintNewBlock(testutil.TimestampNow())
	require.NoError(err)
	require.NoError(bc.CommitBlock(blk))
	return bc, sf, kv, dao, ap
}

func makeTransfer(contract string, bc blockchain.Blockchain, ap actpool.ActPool, t *testing.T) *block.Block {
	require := require.New(t)
	genesisPriKey := identityset.PrivateKey(27)
	// make a transfer for contract,transfer 1 to io16eur00s9gdvak4ujhpuk9a45x24n60jgecgxzz
	bytecode, err := hex.DecodeString("a9059cbb0000000000000000000000004867c4bada9553216bf296c4c64e9ff0749206490000000000000000000000000000000000000000000000000000000000000001")
	require.NoError(err)
	execution, err := action.NewExecution(contract, 4, big.NewInt(0), 1000000, big.NewInt(testutil.TestGasPriceInt64), bytecode)
	require.NoError(err)
	bd := &action.EnvelopeBuilder{}
	elp := bd.SetAction(execution).
		SetNonce(4).
		SetGasLimit(1000000).
		SetGasPrice(big.NewInt(testutil.TestGasPriceInt64)).Build()
	selp, err := action.Sign(elp, genesisPriKey)
	require.NoError(err)
	require.NoError(ap.Add(context.Background(), selp))
	blk, err := bc.MintNewBlock(testutil.TimestampNow())
	require.NoError(err)
	require.NoError(bc.CommitBlock(blk))
	return blk
}

// TODO: add func TestValidateBlock()
